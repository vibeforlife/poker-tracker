<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fold and Furious Poker App Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e4e4e4;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      background: #2a2a40;
      border: none;
      border-radius: 8px;
      color: #e4e4e4;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
    }

    .tab:hover {
      background: #3a3a50;
    }

    .tab.active {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: #2a2a40;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(243, 156, 18, 0.4);
    }

    .btn-secondary {
      background: #3a3a50;
      color: #e4e4e4;
    }

    .btn-secondary:hover {
      background: #4a4a60;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    input, select, textarea {
      padding: 10px;
      border: 1px solid #3a3a50;
      border-radius: 8px;
      background: #1a1a2e;
      color: #e4e4e4;
      font-size: 14px;
      width: 100%;
      margin: 5px 0;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #f39c12;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #2a2a40;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .player-list {
      display: grid;
      gap: 10px;
    }

    .player-item {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .night-item {
      background: #1a1a2e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .night-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .night-info {
      flex: 1;
    }

    .night-meta {
      font-size: 0.9em;
      color: #aaa;
      margin: 5px 0;
    }

    .checkbox-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
    }

    .checkbox-item {
      padding: 10px;
      background: #1a1a2e;
      margin: 5px 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #1a1a2e;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .leaderboard-item:hover {
      background: #2a2a3e;
      transform: translateX(5px);
    }

    .achievement {
      display: inline-block;
      padding: 5px 10px;
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      border-radius: 20px;
      margin: 5px;
      font-size: 12px;
      animation: pop 0.5s ease;
    }

    @keyframes pop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #f39c12;
    }

    .stat-label {
      font-size: 0.9em;
      color: #aaa;
      margin-top: 5px;
    }

    .attendee-input {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }

    .sort-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .badge-card {
      background: #1a1a2e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .badge-header {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    .badge-players {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .badge-player-tag {
      background: #2a2a40;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
    }

    .year-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.8em;
      }

      .tabs {
        justify-content: center;
      }

      .tab {
        flex: 1;
        min-width: 120px;
      }

      .attendee-input {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üÉè Fold and Furious Poker Tracker</h1>

    <div class="top-controls">
      <button class="btn btn-secondary" onclick="app.undo()">‚Ü∂ Undo</button>
      <div>
        <button class="btn btn-primary" onclick="app.showQRCode()">üì± Share Viewer</button>
        <button class="btn btn-secondary" onclick="app.exportForViewers()">üì§ Export for Viewers</button>
        <button class="btn btn-secondary" onclick="app.exportData()">‚¨á Export Backup</button>
        <button class="btn btn-secondary" onclick="app.importData()">‚¨Ü Import</button>
        <button class="btn btn-danger" onclick="app.closeYear()">üîí Close Year</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="app.switchTab('nights')">Poker Nights</button>
      <button class="tab" onclick="app.switchTab('players')">Players</button>
      <button class="tab" onclick="app.switchTab('leaderboard')">Leaderboard</button>
      <button class="tab" onclick="app.switchTab('charts')">Charts</button>
      <button class="tab" onclick="app.switchTab('badges')">Badges</button>
      <button class="tab" onclick="app.switchTab('lifetime')">Lifetime Stats</button>
    </div>

    <div id="nights" class="tab-content active">
      <div class="card">
        <h2>Add New Poker Night</h2>
        <input type="text" id="newNightName" placeholder="Night name (e.g., 'Friday Night Poker')">
        <div class="form-row">
          <input type="date" id="newNightDate">
          <input type="time" id="newNightTime">
        </div>
        <input type="text" id="newNightLocation" placeholder="Location">
        <button class="btn btn-primary" onclick="app.addNight()">Add Night</button>
      </div>
      
      <div class="card">
        <h3>Sort By</h3>
        <div class="sort-controls">
          <button class="btn btn-secondary" onclick="app.sortNights('newest')">Newest First</button>
          <button class="btn btn-secondary" onclick="app.sortNights('oldest')">Oldest First</button>
          <button class="btn btn-secondary" onclick="app.sortNights('name')">Name</button>
          <button class="btn btn-secondary" onclick="app.sortNights('location')">Location</button>
        </div>
      </div>
      
      <div id="nightsList"></div>
    </div>

    <div id="players" class="tab-content">
      <div class="card">
        <h2>Add New Player</h2>
        <input type="text" id="newPlayerName" placeholder="Player name">
        <input type="email" id="newPlayerEmail" placeholder="Email address">
        <button class="btn btn-primary" onclick="app.addPlayer()">Add Player</button>
      </div>
      <div class="card">
        <h2>Players</h2>
        <div id="playersList"></div>
      </div>
    </div>

    <div id="leaderboard" class="tab-content">
      <div class="year-selector">
        <label>View Year:</label>
        <select id="leaderboardYearSelect" onchange="app.renderLeaderboard()">
          <option value="current">Current Year</option>
        </select>
      </div>
      <div class="card">
        <h2>üèÜ Leaderboard</h2>
        <div id="leaderboardList"></div>
      </div>
    </div>

    <div id="charts" class="tab-content">
      <div class="year-selector">
        <label>View Year:</label>
        <select id="chartsYearSelect" onchange="app.renderCharts()">
          <option value="current">Current Year</option>
        </select>
      </div>
      <div class="card">
        <h2>Total Winnings</h2>
        <div class="chart-container">
          <canvas id="totalWinningsChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h2>Games Played</h2>
        <div class="chart-container">
          <canvas id="gamesPlayedChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h2>Average Winnings</h2>
        <div class="chart-container">
          <canvas id="avgWinningsChart"></canvas>
        </div>
      </div>
    </div>

    <div id="badges" class="tab-content">
      <div class="card">
        <h2>üèÖ All Badges</h2>
        <div id="badgesList"></div>
      </div>
    </div>

    <div id="lifetime" class="tab-content">
      <div class="card">
        <h2>üåü Lifetime Leaderboard</h2>
        <div id="lifetimeLeaderboard"></div>
      </div>
      <div class="card">
        <h2>Year by Year</h2>
        <div id="yearByYearStats"></div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="editNightModal" class="modal">
    <div class="modal-content">
      <h2>Edit Poker Night</h2>
      <div id="editNightContent"></div>
      <button class="btn btn-secondary" onclick="app.closeModal('editNightModal')">Close</button>
    </div>
  </div>

  <div id="playerProfileModal" class="modal">
    <div class="modal-content">
      <h2 id="playerProfileName"></h2>
      <div id="playerProfileContent"></div>
      <div class="chart-container">
        <canvas id="playerHistoryChart"></canvas>
      </div>
      <button class="btn btn-secondary" onclick="app.closeModal('playerProfileModal')">Close</button>
    </div>
  </div>

  <div id="settlementModal" class="modal">
    <div class="modal-content">
      <h2>Settlement</h2>
      <div id="settlementContent"></div>
      <button class="btn btn-secondary" onclick="app.closeModal('settlementModal')">Close</button>
    </div>
  </div>

  <div id="qrModal" class="modal">
    <div class="modal-content">
      <h2>üì± Share Viewer Access</h2>
      <p style="margin-bottom: 20px;">Players can scan this QR code to access the read-only viewer:</p>
      <div style="text-align: center; margin: 20px 0;">
        <canvas id="qrCanvas" style="max-width: 300px; width: 100%;"></canvas>
      </div>
      <div style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <strong>Viewer URL:</strong><br>
        <input type="text" id="viewerUrl" readonly style="margin-top: 10px;" value="">
      </div>
      <p style="font-size: 0.9em; color: #aaa;">
        ‚ö†Ô∏è Note: You must upload poker-data.json to your hosting first for the viewer to work.
      </p>
      <button class="btn btn-secondary" onclick="app.closeModal('qrModal')">Close</button>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h2>Confirm Delete</h2>
      <p id="confirmMessage"></p>
      <button class="btn btn-danger" id="confirmYes">Yes, Delete</button>
      <button class="btn btn-secondary" id="confirmNo">Cancel</button>
    </div>
  </div>

  <script>
    const app = {
      data: {
        players: [],
        nights: [],
        archivedYears: {},
        currentYear: new Date().getFullYear()
      },
      history: [],
      charts: {},
      currentSort: 'newest',
      pendingDelete: null,

      showConfirm(message, callback) {
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.add('active');
        
        const yesBtn = document.getElementById('confirmYes');
        const noBtn = document.getElementById('confirmNo');
        
        const handleYes = () => {
          callback();
          this.closeModal('confirmModal');
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
        };
        
        const handleNo = () => {
          this.closeModal('confirmModal');
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
        };
        
        yesBtn.addEventListener('click', handleYes);
        noBtn.addEventListener('click', handleNo);
      },

      init() {
        this.loadData();
        this.render();
        this.populateYearSelectors();
      },

      saveState() {
        this.history.push(JSON.stringify(this.data));
        if (this.history.length > 30) this.history.shift();
      },

      undo() {
        if (this.history.length === 0) {
          alert('Nothing to undo');
          return;
        }
        this.data = JSON.parse(this.history.pop());
        this.saveData();
        this.render();
      },

      loadData() {
        const saved = localStorage.getItem('pokerTrackerData');
        if (saved) {
          this.data = JSON.parse(saved);
          if (!this.data.archivedYears) this.data.archivedYears = {};
          if (!this.data.currentYear) this.data.currentYear = new Date().getFullYear();
        }
      },

      saveData() {
        localStorage.setItem('pokerTrackerData', JSON.stringify(this.data));
      },

      exportData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'poker-tracker-backup.json';
        a.click();
        URL.revokeObjectURL(url);
      },

      exportForViewers() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'poker-data.json';
        a.click();
        URL.revokeObjectURL(url);
        alert('poker-data.json downloaded! Upload this file to your hosting to update the viewer.');
      },

      showQRCode() {
        // CONFIGURATION: Set your viewer URL here
        const VIEWER_URL = 'https://vibeforlife.github.io/poker-tracker/poker-viewer.html';
        
        document.getElementById('viewerUrl').value = VIEWER_URL;
        
        // Generate QR code
        const canvas = document.getElementById('qrCanvas');
        this.generateQR(canvas, VIEWER_URL);
        
        document.getElementById('qrModal').classList.add('active');
      },

      generateQR(canvas, text) {
        // Simple QR code generator using canvas
        const ctx = canvas.getContext('2d');
        const size = 300;
        canvas.width = size;
        canvas.height = size;
        
        // This is a simplified QR code using API
        // In production, you'd use qrcode.js library
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}`;
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          ctx.drawImage(img, 0, 0, size, size);
        };
        img.src = qrUrl;
      },

      importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              this.saveState();
              this.data = JSON.parse(event.target.result);
              this.saveData();
              this.render();
              alert('Data imported successfully!');
            } catch (err) {
              alert('Error importing data: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      },

      closeYear() {
        this.showConfirm(`Close ${this.data.currentYear} and start a new year? This will archive all current data.`, () => {
          this.saveState();
          this.data.archivedYears[this.data.currentYear] = {
            players: JSON.parse(JSON.stringify(this.data.players)),
            nights: JSON.parse(JSON.stringify(this.data.nights))
          };
          
          this.data.nights = [];
          this.data.currentYear = new Date().getFullYear();
          this.saveData();
          this.render();
          this.populateYearSelectors();
          alert(`Year ${this.data.currentYear - 1} closed successfully! Starting fresh for ${this.data.currentYear}.`);
        });
      },

      populateYearSelectors() {
        const years = Object.keys(this.data.archivedYears).sort((a, b) => b - a);
        
        ['leaderboardYearSelect', 'chartsYearSelect'].forEach(selectId => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="current">Current Year (' + this.data.currentYear + ')</option>';
          years.forEach(year => {
            select.innerHTML += `<option value="${year}">${year}</option>`;
          });
        });
      },

      getYearData(year) {
        if (year === 'current') {
          return { players: this.data.players, nights: this.data.nights };
        }
        return this.data.archivedYears[year] || { players: [], nights: [] };
      },

      switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab).classList.add('active');
        
        if (tab === 'charts') this.renderCharts();
        if (tab === 'leaderboard') this.renderLeaderboard();
        if (tab === 'badges') this.renderBadges();
        if (tab === 'lifetime') this.renderLifetimeStats();
      },

      addPlayer() {
        const name = document.getElementById('newPlayerName').value.trim();
        const email = document.getElementById('newPlayerEmail').value.trim();
        
        if (!name) {
          alert('Please enter a player name');
          return;
        }
        if (this.data.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
          alert('Player already exists');
          return;
        }
        
        this.saveState();
        this.data.players.push({ id: Date.now(), name, email });
        document.getElementById('newPlayerName').value = '';
        document.getElementById('newPlayerEmail').value = '';
        this.saveData();
        this.render();
      },

      deletePlayer(id) {
        this.showConfirm('Delete this player? They will be removed from all nights.', () => {
          this.saveState();
          this.data.players = this.data.players.filter(p => p.id !== id);
          this.data.nights.forEach(night => {
            night.attendees = night.attendees.filter(a => a.playerId !== id);
          });
          this.saveData();
          this.render();
        });
      },

      generateCalendarInvite(night) {
        const startDate = new Date(night.date + 'T' + (night.time || '19:00'));
        const endDate = new Date(startDate.getTime() + 4 * 60 * 60 * 1000); // 4 hours later
        
        const formatDate = (date) => {
          return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        };

        // Create ICS file content
        const attendees = this.data.players
          .filter(p => p.email)
          .map(p => `ATTENDEE;CN=${p.name};RSVP=TRUE:mailto:${p.email}`)
          .join('\r\n');

        const icsContent = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//Fold and Furious Poker Tracker//EN',
          'BEGIN:VEVENT',
          `DTSTART:${formatDate(startDate)}`,
          `DTEND:${formatDate(endDate)}`,
          `SUMMARY:${night.name || 'Poker Night'}`,
          `DESCRIPTION:Poker night organized via Fold and Furious Poker Tracker`,
          `LOCATION:${night.location || ''}`,
          attendees,
          'STATUS:CONFIRMED',
          'END:VEVENT',
          'END:VCALENDAR'
        ].join('\r\n');

        return icsContent;
      },

      sendCalendarInvites(night) {
        const icsContent = this.generateCalendarInvite(night);
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `poker-night-${night.date}.ics`;
        a.click();
        URL.revokeObjectURL(url);
        
        const emails = this.data.players.filter(p => p.email).map(p => p.email).join(',');
        if (emails) {
          alert(`Calendar invite downloaded! Send the .ics file to: ${emails}`);
        } else {
          alert('Calendar invite downloaded! Add email addresses to players to include them as attendees.');
        }
      },

      addNight() {
        const name = document.getElementById('newNightName').value.trim();
        const date = document.getElementById('newNightDate').value;
        const time = document.getElementById('newNightTime').value;
        const location = document.getElementById('newNightLocation').value.trim();
        
        if (!date) {
          alert('Please select a date');
          return;
        }
        
        this.saveState();
        const newNight = {
          id: Date.now(),
          name: name || 'Poker Night',
          date,
          time: time || '19:00',
          location: location || '',
          attendees: [],
          buyIn: 20
        };
        
        this.data.nights.push(newNight);
        this.sortNights(this.currentSort);
        
        document.getElementById('newNightName').value = '';
        document.getElementById('newNightDate').value = '';
        document.getElementById('newNightTime').value = '';
        document.getElementById('newNightLocation').value = '';
        
        this.saveData();
        this.render();
        
        if (confirm('Send calendar invites to all players?')) {
          this.sendCalendarInvites(newNight);
        }
      },

      sortNights(method) {
        this.currentSort = method;
        
        switch(method) {
          case 'newest':
            this.data.nights.sort((a, b) => new Date(b.date) - new Date(a.date));
            break;
          case 'oldest':
            this.data.nights.sort((a, b) => new Date(a.date) - new Date(b.date));
            break;
          case 'name':
            this.data.nights.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            break;
          case 'location':
            this.data.nights.sort((a, b) => (a.location || '').localeCompare(b.location || ''));
            break;
        }
        
        this.render();
      },

      deleteNight(id) {
        this.showConfirm('Delete this poker night?', () => {
          this.saveState();
          this.data.nights = this.data.nights.filter(n => n.id !== id);
          this.saveData();
          this.render();
        });
      },

      editNight(id) {
        const night = this.data.nights.find(n => n.id === id);
        const content = document.getElementById('editNightContent');
        
        content.innerHTML = `
          <label>Night Name:</label>
          <input type="text" id="editNightName" value="${night.name || ''}">
          <div class="form-row">
            <div>
              <label>Date:</label>
              <input type="date" id="editNightDate" value="${night.date}">
            </div>
            <div>
              <label>Time:</label>
              <input type="time" id="editNightTime" value="${night.time || '19:00'}">
            </div>
          </div>
          <label>Location:</label>
          <input type="text" id="editNightLocation" value="${night.location || ''}">
          <label>Default Buy-In:</label>
          <input type="number" id="editBuyIn" value="${night.buyIn}">
          <h3>Select Attendees</h3>
          <input type="text" id="playerSearch" placeholder="Search players..." onkeyup="app.filterPlayers()">
          <div class="checkbox-list" id="attendeeCheckboxes"></div>
          <h3>Attendee Results</h3>
          <div id="attendeeResults"></div>
          <button class="btn btn-primary" onclick="app.saveNight(${id})">Save</button>
          <button class="btn btn-secondary" onclick="app.calculateSettlement(${id})">Calculate Settlement</button>
        `;

        const checkboxContainer = document.getElementById('attendeeCheckboxes');
        this.data.players.forEach(player => {
          const checked = night.attendees.some(a => a.playerId === player.id);
          checkboxContainer.innerHTML += `
            <div class="checkbox-item">
              <input type="checkbox" id="player_${player.id}" ${checked ? 'checked' : ''}>
              <label for="player_${player.id}">${player.name}</label>
            </div>
          `;
        });

        this.updateAttendeeResults(night);
        document.getElementById('editNightModal').classList.add('active');
      },

      filterPlayers() {
        const search = document.getElementById('playerSearch').value.toLowerCase();
        document.querySelectorAll('.checkbox-item').forEach(item => {
          const label = item.querySelector('label').textContent.toLowerCase();
          item.style.display = label.includes(search) ? 'flex' : 'none';
        });
      },

      updateAttendeeResults(night) {
        const resultsDiv = document.getElementById('attendeeResults');
        resultsDiv.innerHTML = '';
        
        night.attendees.forEach(attendee => {
          const player = this.data.players.find(p => p.id === attendee.playerId);
          if (!player) return;
          
          resultsDiv.innerHTML += `
            <div class="attendee-input">
              <span>${player.name}</span>
              <input type="number" value="${attendee.winnings}" onchange="app.updateWinnings(${night.id}, ${attendee.playerId}, this.value)">
              <button class="btn btn-danger" onclick="app.removeAttendee(${night.id}, ${attendee.playerId})">Remove</button>
            </div>
          `;
        });

        const total = night.attendees.reduce((sum, a) => sum + parseFloat(a.winnings || 0), 0);
        resultsDiv.innerHTML += `<p><strong>Night Total: $${total.toFixed(2)}</strong></p>`;
      },

      saveNight(id) {
        this.saveState();
        const night = this.data.nights.find(n => n.id === id);
        night.name = document.getElementById('editNightName').value.trim() || 'Poker Night';
        night.date = document.getElementById('editNightDate').value;
        night.time = document.getElementById('editNightTime').value || '19:00';
        night.location = document.getElementById('editNightLocation').value.trim();
        night.buyIn = parseFloat(document.getElementById('editBuyIn').value) || 20;
        
        const currentAttendeeIds = night.attendees.map(a => a.playerId);
        const selectedIds = [];
        
        this.data.players.forEach(player => {
          const checkbox = document.getElementById(`player_${player.id}`);
          if (checkbox && checkbox.checked) {
            selectedIds.push(player.id);
            if (!currentAttendeeIds.includes(player.id)) {
              night.attendees.push({
                playerId: player.id,
                winnings: -night.buyIn
              });
            }
          }
        });

        night.attendees = night.attendees.filter(a => selectedIds.includes(a.playerId));
        this.saveData();
        this.updateAttendeeResults(night);
      },

      updateWinnings(nightId, playerId, value) {
        const night = this.data.nights.find(n => n.id === nightId);
        const attendee = night.attendees.find(a => a.playerId === playerId);
        attendee.winnings = parseFloat(value) || 0;
        this.saveData();
        this.updateAttendeeResults(night);
      },

      removeAttendee(nightId, playerId) {
        const night = this.data.nights.find(n => n.id === nightId);
        night.attendees = night.attendees.filter(a => a.playerId !== playerId);
        this.saveData();
        this.updateAttendeeResults(night);
      },

      calculateSettlement(nightId) {
        const night = this.data.nights.find(n => n.id === nightId);
        const balances = night.attendees.map(a => ({
          player: this.data.players.find(p => p.id === a.playerId).name,
          balance: a.winnings
        })).sort((a, b) => a.balance - b.balance);

        const transactions = [];
        const debtors = balances.filter(b => b.balance < 0).map(b => ({...b}));
        const creditors = balances.filter(b => b.balance > 0).map(b => ({...b}));

        debtors.forEach(debtor => {
          let remaining = -debtor.balance;
          creditors.forEach(creditor => {
            if (remaining > 0 && creditor.balance > 0) {
              const amount = Math.min(remaining, creditor.balance);
              transactions.push(`${debtor.player} pays ${creditor.player}: $${amount.toFixed(2)}`);
              remaining -= amount;
              creditor.balance -= amount;
            }
          });
        });

        const content = document.getElementById('settlementContent');
        content.innerHTML = transactions.length > 0 
          ? transactions.join('<br>') 
          : 'All settled!';
        document.getElementById('settlementModal').classList.add('active');
      },

      getPlayerStats(yearData = null) {
        const data = yearData || { players: this.data.players, nights: this.data.nights };
        
        return data.players.map(player => {
          const games = data.nights.filter(n => 
            n.attendees.some(a => a.playerId === player.id)
          ).length;
          
          const totalWinnings = data.nights.reduce((sum, night) => {
            const attendee = night.attendees.find(a => a.playerId === player.id);
            return sum + (attendee ? attendee.winnings : 0);
          }, 0);

          const avgWinnings = games > 0 ? totalWinnings / games : 0;

          return {
            id: player.id,
            name: player.name,
            games,
            totalWinnings,
            avgWinnings
          };
        });
      },

      getAchievements(stats, yearData = null) {
        const achievements = [];
        const data = yearData || { players: this.data.players, nights: this.data.nights };
        const allStats = this.getPlayerStats(yearData);
        const maxWinnings = Math.max(...allStats.map(s => s.totalWinnings));
        const maxAvg = Math.max(...allStats.filter(s => s.games >= 10).map(s => s.avgWinnings));
        
        if (stats.totalWinnings === maxWinnings && maxWinnings > 0) {
          achievements.push('üèÜ Top Earner YTD');
        }
        
        const playerNights = data.nights
          .filter(n => n.attendees.some(a => a.playerId === stats.id))
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        let streak = 0;
        let maxStreak = 0;
        playerNights.forEach(night => {
          const attendee = night.attendees.find(a => a.playerId === stats.id);
          if (attendee.winnings > 0) {
            streak++;
            maxStreak = Math.max(maxStreak, streak);
          } else {
            streak = 0;
          }
        });
        if (maxStreak >= 3) achievements.push('üî• Hot Streak');
        
        const maxWin = Math.max(...playerNights.map(n => {
          const a = n.attendees.find(at => at.playerId === stats.id);
          return a ? a.winnings : -Infinity;
        }), 0);
        if (maxWin >= 100) achievements.push('üíé High Roller');
        
        let minRunning = 0;
        let running = 0;
        let maxComeback = 0;
        playerNights.forEach(night => {
          const attendee = night.attendees.find(a => a.playerId === stats.id);
          running += attendee.winnings;
          if (running < minRunning) minRunning = running;
          maxComeback = Math.max(maxComeback, running - minRunning);
        });
        if (maxComeback >= 150) achievements.push('üìà Comeback Kid');
        
        if (stats.games >= 5) achievements.push('üéÆ Regular Player');
        if (stats.games >= 20) achievements.push('üåü Veteran');
        if (stats.games >= 50) achievements.push('üíØ Half Century');
        
        if (data.nights.length > 0) {
          const firstNight = [...data.nights].sort((a, b) => 
            new Date(a.date) - new Date(b.date)
          )[0];
          if (firstNight.attendees.some(a => a.playerId === stats.id)) {
            achievements.push('üåü Founding Member');
          }
        }
        
        if (stats.games >= 10 && stats.avgWinnings === maxAvg && maxAvg > 0) {
          achievements.push('üìä Best Average');
        }
        
        if (stats.games >= 10 && Math.abs(stats.totalWinnings) <= 50) {
          achievements.push('‚öñÔ∏è Balanced');
        }
        
        if (stats.games >= 6) {
          const monthlyTotals = {};
          playerNights.forEach(night => {
            const month = night.date.substring(0, 7);
            if (!monthlyTotals[month]) monthlyTotals[month] = 0;
            const attendee = night.attendees.find(a => a.playerId === stats.id);
            monthlyTotals[month] += attendee.winnings;
          });
          const allPositive = Object.values(monthlyTotals).every(v => v > 0);
          if (allPositive && Object.keys(monthlyTotals).length >= 3) {
            achievements.push('üí∞ Profit Machine');
          }
        }
        
        if (stats.totalWinnings >= 1000) achievements.push('üíµ $1K Club');
        if (stats.totalWinnings >= 5000) achievements.push('üíé $5K Club');
        
        if (stats.games >= 10) {
          const winnings = playerNights.map(n => {
            const a = n.attendees.find(at => at.playerId === stats.id);
            return a ? a.winnings : 0;
          });
          const mean = winnings.reduce((a, b) => a + b, 0) / winnings.length;
          const variance = winnings.reduce((sum, w) => sum + Math.pow(w - mean, 2), 0) / winnings.length;
          const stdDev = Math.sqrt(variance);
          if (stdDev < 30) achievements.push('üéØ Consistent');
          if (stdDev > 80) achievements.push('üÉè Wild Card');
        }
        
        const uniqueOpponents = new Set();
        playerNights.forEach(night => {
          night.attendees.forEach(a => {
            if (a.playerId !== stats.id) uniqueOpponents.add(a.playerId);
          });
        });
        if (uniqueOpponents.size === data.players.length - 1 && data.players.length >= 5) {
          achievements.push('ü§ù Social Butterfly');
        }
        
        return achievements;
      },

      showPlayerProfile(playerId) {
        const player = this.data.players.find(p => p.id === playerId);
        const stats = this.getPlayerStats().find(s => s.id === playerId);
        const achievements = this.getAchievements(stats);

        document.getElementById('playerProfileName').textContent = player.name;
        
        const content = document.getElementById('playerProfileContent');
        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">${stats.games}</div>
              <div class="stat-label">Games Played</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">$${stats.totalWinnings.toFixed(2)}</div>
              <div class="stat-label">Total Winnings</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">$${stats.avgWinnings.toFixed(2)}</div>
              <div class="stat-label">Avg per Game</div>
            </div>
          </div>
          <h3>Achievements</h3>
          <div>
            ${achievements.map(a => `<span class="achievement">${a}</span>`).join('')}
            ${achievements.length === 0 ? '<p>No achievements yet</p>' : ''}
          </div>
          <h3>Performance Over Time</h3>
        `;

        const history = this.data.nights
          .filter(n => n.attendees.some(a => a.playerId === playerId))
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .map(night => ({
            date: night.date,
            winnings: night.attendees.find(a => a.playerId === playerId).winnings
          }));

        const ctx = document.getElementById('playerHistoryChart');
        if (this.charts.playerHistory) this.charts.playerHistory.destroy();
        
        this.charts.playerHistory = new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.map(h => h.date),
            datasets: [{
              label: 'Winnings',
              data: history.map(h => h.winnings),
              borderColor: '#f39c12',
              backgroundColor: 'rgba(243, 156, 18, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                ticks: { color: '#e4e4e4' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              x: {
                ticks: { color: '#e4e4e4' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });

        document.getElementById('playerProfileModal').classList.add('active');
      },

      renderLeaderboard() {
        const year = document.getElementById('leaderboardYearSelect').value;
        const yearData = this.getYearData(year);
        const stats = this.getPlayerStats(yearData).sort((a, b) => b.totalWinnings - a.totalWinnings);
        const list = document.getElementById('leaderboardList');
        
        list.innerHTML = stats.map((s, i) => {
          const achievements = this.getAchievements(s, yearData);
          return `
            <div class="leaderboard-item" onclick="app.showPlayerProfile(${s.id})">
              <div>
                <strong>${i + 1}. ${s.name}</strong>
                <div>${achievements.map(a => `<span class="achievement">${a}</span>`).join('')}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 1.5em; color: ${s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c'}">
                  $${s.totalWinnings.toFixed(2)}
                </div>
                <div style="font-size: 0.9em; color: #aaa;">
                  ${s.games} games ‚Ä¢ $${s.avgWinnings.toFixed(2)} avg
                </div>
              </div>
            </div>
          `;
        }).join('');
      },

      renderCharts() {
        const year = document.getElementById('chartsYearSelect').value;
        const yearData = this.getYearData(year);
        const stats = this.getPlayerStats(yearData).sort((a, b) => b.totalWinnings - a.totalWinnings);

        const ctx1 = document.getElementById('totalWinningsChart');
        if (this.charts.totalWinnings) this.charts.totalWinnings.destroy();
        this.charts.totalWinnings = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: stats.map(s => s.name),
            datasets: [{
              label: 'Total Winnings',
              data: stats.map(s => s.totalWinnings),
              backgroundColor: stats.map(s => s.totalWinnings >= 0 ? 'rgba(46, 204, 113, 0.8)' : 'rgba(231, 76, 60, 0.8)')
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
              x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            }
          }
        });

        const ctx2 = document.getElementById('gamesPlayedChart');
        if (this.charts.gamesPlayed) this.charts.gamesPlayed.destroy();
        this.charts.gamesPlayed = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: stats.map(s => s.name),
            datasets: [{
              label: 'Games Played',
              data: stats.map(s => s.games),
              backgroundColor: 'rgba(243, 156, 18, 0.8)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
              x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            }
          }
        });

        const ctx3 = document.getElementById('avgWinningsChart');
        if (this.charts.avgWinnings) this.charts.avgWinnings.destroy();
        this.charts.avgWinnings = new Chart(ctx3, {
          type: 'line',
          data: {
            labels: stats.map(s => s.name),
            datasets: [{
              label: 'Average Winnings',
              data: stats.map(s => s.avgWinnings),
              borderColor: '#9b59b6',
              backgroundColor: 'rgba(155, 89, 182, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
              x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            }
          }
        });
      },

      renderBadges() {
        const badgeDefinitions = [
          { badge: 'üèÜ Top Earner YTD', description: 'Highest total winnings this year' },
          { badge: 'üî• Hot Streak', description: '3+ wins in a row' },
          { badge: 'üíé High Roller', description: 'Single win of $100+' },
          { badge: 'üìà Comeback Kid', description: 'Recovered $150+ from low point' },
          { badge: 'üéÆ Regular Player', description: '5+ games played' },
          { badge: 'üåü Veteran', description: '20+ games played' },
          { badge: 'üíØ Half Century', description: '50+ games played' },
          { badge: 'üåü Founding Member', description: 'Played in the first game' },
          { badge: 'üìä Best Average', description: 'Highest avg winnings (min 10 games)' },
          { badge: '‚öñÔ∏è Balanced', description: 'Within $50 of break-even (min 10 games)' },
          { badge: 'üí∞ Profit Machine', description: 'Positive every month for 3+ months' },
          { badge: 'üíµ $100 Club', description: '$100+ total winnings' },
          { badge: 'üíé $500 Club', description: '$500+ total winnings' },
          { badge: 'üéØ Consistent', description: 'Low variance in results' },
          { badge: 'üÉè Wild Card', description: 'High variance in results' },
          { badge: 'ü§ù Social Butterfly', description: 'Played with every other player' }
        ];

        const stats = this.getPlayerStats();
        const badgeHolders = {};

        stats.forEach(s => {
          const achievements = this.getAchievements(s);
          achievements.forEach(badge => {
            if (!badgeHolders[badge]) badgeHolders[badge] = [];
            badgeHolders[badge].push(s.name);
          });
        });

        const list = document.getElementById('badgesList');
        list.innerHTML = badgeDefinitions.map(def => {
          const holders = badgeHolders[def.badge] || [];
          return `
            <div class="badge-card">
              <div class="badge-header">${def.badge}</div>
              <div style="color: #aaa; margin-bottom: 10px;">${def.description}</div>
              <div class="badge-players">
                ${holders.length > 0 
                  ? holders.map(name => `<span class="badge-player-tag">${name}</span>`).join('') 
                  : '<span style="color: #888;">No players have earned this badge yet</span>'}
              </div>
            </div>
          `;
        }).join('');
      },

      renderLifetimeStats() {
        const lifetimeStats = {};
        
        this.data.players.forEach(player => {
          lifetimeStats[player.id] = {
            name: player.name,
            totalGames: 0,
            totalWinnings: 0,
            years: {}
          };
        });

        Object.keys(this.data.archivedYears).forEach(year => {
          const yearData = this.data.archivedYears[year];
          const yearStats = this.getPlayerStats(yearData);
          
          yearStats.forEach(s => {
            if (lifetimeStats[s.id]) {
              lifetimeStats[s.id].totalGames += s.games;
              lifetimeStats[s.id].totalWinnings += s.totalWinnings;
              lifetimeStats[s.id].years[year] = {
                games: s.games,
                winnings: s.totalWinnings
              };
            }
          });
        });

        const currentStats = this.getPlayerStats();
        currentStats.forEach(s => {
          if (lifetimeStats[s.id]) {
            lifetimeStats[s.id].totalGames += s.games;
            lifetimeStats[s.id].totalWinnings += s.totalWinnings;
            lifetimeStats[s.id].years[this.data.currentYear] = {
              games: s.games,
              winnings: s.totalWinnings
            };
          }
        });

        const sortedLifetime = Object.values(lifetimeStats)
          .filter(s => s.totalGames > 0)
          .sort((a, b) => b.totalWinnings - a.totalWinnings);

        const lifetimeList = document.getElementById('lifetimeLeaderboard');
        lifetimeList.innerHTML = sortedLifetime.map((s, i) => `
          <div class="leaderboard-item">
            <div>
              <strong>${i + 1}. ${s.name}</strong>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 1.5em; color: ${s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c'}">
                $${s.totalWinnings.toFixed(2)}
              </div>
              <div style="font-size: 0.9em; color: #aaa;">
                ${s.totalGames} lifetime games ‚Ä¢ $${(s.totalWinnings / s.totalGames).toFixed(2)} avg
              </div>
            </div>
          </div>
        `).join('');

        const yearByYear = document.getElementById('yearByYearStats');
        const years = [...new Set([...Object.keys(this.data.archivedYears), this.data.currentYear.toString()])].sort((a, b) => b - a);
        
        yearByYear.innerHTML = years.map(year => {
          const yearData = year == this.data.currentYear 
            ? { players: this.data.players, nights: this.data.nights }
            : this.data.archivedYears[year];
          
          if (!yearData || !yearData.nights || yearData.nights.length === 0) return '';
          
          const yearStats = this.getPlayerStats(yearData).sort((a, b) => b.totalWinnings - a.totalWinnings);
          const topPlayer = yearStats[0];
          
          return `
            <div class="card">
              <h3>${year} ${year == this.data.currentYear ? '(Current)' : ''}</h3>
              <p>Games: ${yearData.nights.length}</p>
              <p>Top Player: ${topPlayer ? `${topPlayer.name} ($${topPlayer.totalWinnings.toFixed(2)})` : 'N/A'}</p>
            </div>
          `;
        }).join('');
      },

      closeModal(id) {
        document.getElementById(id).classList.remove('active');
      },

      render() {
        const playersList = document.getElementById('playersList');
        if (playersList) {
          playersList.innerHTML = this.data.players.map(p => `
            <div class="player-item">
              <div>
                <strong>${p.name}</strong>
                ${p.email ? `<div style="font-size: 0.9em; color: #aaa;">${p.email}</div>` : ''}
              </div>
              <button class="btn btn-danger" onclick="app.deletePlayer(${p.id})">Delete</button>
            </div>
          `).join('');
        }

        const nightsList = document.getElementById('nightsList');
        if (nightsList) {
          nightsList.innerHTML = this.data.nights.map(n => `
            <div class="night-item">
              <div class="night-header">
                <div class="night-info">
                  <h3>${n.name || 'Poker Night'}</h3>
                  <div class="night-meta">üìÖ ${n.date} ${n.time ? '‚Ä¢ üïê ' + n.time : ''}</div>
                  ${n.location ? `<div class="night-meta">üìç ${n.location}</div>` : ''}
                  <div class="night-meta">üë• ${n.attendees.length} attendees</div>
                </div>
                <div>
                  <button class="btn btn-primary" onclick="app.editNight(${n.id})">Edit</button>
                  <button class="btn btn-secondary" onclick="app.sendCalendarInvites(app.data.nights.find(night => night.id === ${n.id}))">üìÖ Send Invite</button>
                  <button class="btn btn-danger" onclick="app.deleteNight(${n.id})">Delete</button>
                </div>
              </div>
            </div>
          `).join('');
        }

        this.renderLeaderboard();
      }
    };

    app.init();
  </script>
</body>
</html>
