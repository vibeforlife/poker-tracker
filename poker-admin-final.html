<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poker Tracker Admin</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e4e4e4; min-height: 100vh; padding: 20px; }
    .sync-status { position: fixed; top: 10px; right: 10px; background: #2a2a40; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 1000; display: flex; align-items: center; gap: 8px; }
    .sync-indicator { width: 8px; height: 8px; border-radius: 50%; background: #888; }
    .sync-indicator.synced { background: #2ecc71; }
    .sync-indicator.syncing { background: #f39c12; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 2.5em; background: linear-gradient(45deg, #f39c12, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { text-align: center; color: #aaa; margin-bottom: 30px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 12px 24px; background: #2a2a40; border: none; border-radius: 8px; color: #e4e4e4; cursor: pointer; font-size: 16px; }
    .tab:hover { background: #3a3a50; }
    .tab.active { background: linear-gradient(45deg, #f39c12, #e74c3c); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: #2a2a40; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
    .btn-primary { background: linear-gradient(45deg, #f39c12, #e74c3c); color: white; }
    .btn-secondary { background: #3a3a50; color: #e4e4e4; }
    .btn-danger { background: #e74c3c; color: white; }
    input, select, textarea { padding: 10px; border: 1px solid #3a3a50; border-radius: 8px; background: #1a1a2e; color: #e4e4e4; font-size: 14px; width: 100%; margin: 5px 0; }
    textarea { min-height: 80px; resize: vertical; font-family: inherit; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; padding: 20px; overflow-y: auto; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #2a2a40; border-radius: 12px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .top-controls { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    
    .item-card { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.3s; }
    .item-card:hover { background: #2a2a3e; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    
    .player-item { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
    .player-item:hover { background: #2a2a3e; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    
    .night-item { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.3s; }
    .night-item:hover { background: #2a2a3e; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    .night-header { display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px; }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
    .checkbox-list { max-height: 300px; overflow-y: auto; margin: 10px 0; }
    .checkbox-item { padding: 10px; background: #1a1a2e; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .checkbox-item label { flex: 1; cursor: pointer; margin: 0; }
    .checkbox-item input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; }
    .attendee-input { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: center; margin: 10px 0; }
    .notes-display { font-size: 0.9em; color: #aaa; margin-top: 8px; font-style: italic; padding: 8px; background: #2a2a40; border-radius: 6px; }
    
    .achievement { display: inline-block; padding: 5px 10px; background: linear-gradient(45deg, #f39c12, #e74c3c); border-radius: 20px; margin: 5px; font-size: 12px; animation: pop 0.5s ease; }
    @keyframes pop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    
    .badge-card { background: linear-gradient(135deg, #2a2a40 0%, #1a1a2e 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #f39c12; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); transition: transform 0.3s; }
    .badge-card:hover { transform: translateX(5px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4); }
    .badge-header { font-size: 2em; margin-bottom: 15px; }
    .badge-desc { color: #bbb; font-size: 1.1em; margin-bottom: 15px; }
    .badge-divider { height: 1px; background: linear-gradient(90deg, transparent, #f39c12, transparent); margin: 15px 0; }
    .badge-players { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .badge-player-tag { background: linear-gradient(45deg, #3a3a50, #2a2a40); padding: 8px 16px; border-radius: 20px; font-size: 0.95em; border: 1px solid #4a4a60; transition: all 0.3s; }
    .badge-player-tag:hover { background: linear-gradient(45deg, #4a4a60, #3a3a50); transform: scale(1.05); }
    .badge-empty { color: #666; font-style: italic; }
    
    @media (max-width: 768px) { .form-row, .attendee-input { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="sync-status">
    <div class="sync-indicator" id="syncIndicator"></div>
    <span id="syncText">Checking...</span>
  </div>

  <div class="container">
    <h1>üÉè Fold and Furious</h1>
    <p class="subtitle">üëë Admin ‚Ä¢ ‚òÅÔ∏è Cloud Synced</p>

    <div class="top-controls">
      <button class="btn btn-secondary" onclick="app.undo()">‚Ü∂ Undo</button>
      <div>
        <button class="btn btn-secondary" onclick="app.showHandRankings()">üÉè Poker Hands</button>
        <button class="btn btn-secondary" onclick="app.manualSync()">üîÑ Sync</button>
        <button class="btn btn-primary" onclick="app.showQRCode()">üì± Share</button>
        <button class="btn btn-danger" onclick="app.closeYear()">üîí Close Year</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="app.switchTab('nights')">Nights</button>
      <button class="tab" onclick="app.switchTab('players')">Players</button>
      <button class="tab" onclick="app.switchTab('leaderboard')">Leaderboard</button>
      <button class="tab" onclick="app.switchTab('charts')">Charts</button>
      <button class="tab" onclick="app.switchTab('badges')">Badges</button>
      <button class="tab" onclick="app.switchTab('lifetime')">Lifetime</button>
    </div>

    <div id="nights" class="tab-content active">
      <div class="card">
        <h2>Add Night</h2>
        <input type="text" id="newNightName" placeholder="Night name">
        <div class="form-row">
          <input type="date" id="newNightDate">
          <input type="time" id="newNightTime">
        </div>
        <input type="text" id="newNightLocation" placeholder="Location">
        <button class="btn btn-primary" onclick="app.addNight()">Add Night</button>
      </div>
      <div class="card">
        <button class="btn btn-secondary" onclick="app.sortNights('newest')">Newest</button>
        <button class="btn btn-secondary" onclick="app.sortNights('oldest')">Oldest</button>
        <button class="btn btn-secondary" onclick="app.sortNights('name')">Name</button>
        <button class="btn btn-secondary" onclick="app.sortNights('location')">Location</button>
      </div>
      <div id="nightsList"></div>
    </div>

    <div id="players" class="tab-content">
      <div class="card">
        <h2>Add Player</h2>
        <input type="text" id="newPlayerName" placeholder="Name">
        <input type="email" id="newPlayerEmail" placeholder="Email">
        <button class="btn btn-primary" onclick="app.addPlayer()">Add Player</button>
      </div>
      <div class="card"><div id="playersList"></div></div>
    </div>

    <div id="leaderboard" class="tab-content">
      <div class="card"><h2>üèÜ Leaderboard</h2><div id="leaderboardList"></div></div>
    </div>

    <div id="charts" class="tab-content">
      <div class="card"><h2>Total Winnings</h2><div style="height: 300px; position: relative;"><canvas id="totalWinningsChart"></canvas></div></div>
      <div class="card"><h2>Games Played</h2><div style="height: 300px; position: relative;"><canvas id="gamesPlayedChart"></canvas></div></div>
      <div class="card"><h2>Average Winnings</h2><div style="height: 300px; position: relative;"><canvas id="avgWinningsChart"></canvas></div></div>
    </div>

    <div id="badges" class="tab-content">
      <div class="card"><h2>üèÖ All Badges</h2><div id="badgesList"></div></div>
    </div>

    <div id="lifetime" class="tab-content">
      <div class="card"><h2>üåü Lifetime Leaderboard</h2><div id="lifetimeLeaderboard"></div></div>
      <div class="card"><h2>üìÖ Year by Year</h2><div id="yearByYearStats"></div></div>
    </div>
  </div>

  <div id="editNightModal" class="modal">
    <div class="modal-content">
      <h2>Edit Night</h2>
      <div id="editNightContent"></div>
      <button class="btn btn-secondary" onclick="app.closeModal('editNightModal')">Close</button>
    </div>
  </div>

  <div id="playerProfileModal" class="modal">
    <div class="modal-content">
      <h2 id="playerProfileName"></h2>
      <div id="playerProfileContent"></div>
      <button class="btn btn-secondary" onclick="app.closeModal('playerProfileModal')">Close</button>
    </div>
  </div>

  <div id="settlementModal" class="modal">
    <div class="modal-content">
      <h2>Settlement</h2>
      <div id="settlementContent"></div>
      <button class="btn btn-secondary" onclick="app.closeModal('settlementModal')">Close</button>
    </div>
  </div>

  <div id="qrModal" class="modal">
    <div class="modal-content">
      <h2>üì± Share Viewer</h2>
      <div style="text-align: center; margin: 20px 0;">
        <canvas id="qrCanvas" style="max-width: 300px; width: 100%;"></canvas>
      </div>
      <div style="background: #1a1a2e; padding: 15px; border-radius: 8px;">
        <input type="text" readonly value="https://vibeforlife.github.io/poker-tracker/poker-viewer.html" style="text-align: center;">
      </div>
      <button class="btn btn-secondary" onclick="app.closeModal('qrModal')">Close</button>
    </div>
  </div>

  <div id="handRankingsModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <h2>üÉè Poker Hand Rankings</h2>
      <img src="https://raw.githubusercontent.com/vibeforlife/poker-tracker/main/poker%20hand%20rankings.jpg" style="max-width: 100%; border-radius: 8px; margin: 20px 0;">
      <button class="btn btn-secondary" onclick="app.closeModal('handRankingsModal')">Close</button>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h2>Confirm</h2>
      <p id="confirmMessage"></p>
      <button class="btn btn-danger" id="confirmYes">Yes</button>
      <button class="btn btn-secondary" id="confirmNo">Cancel</button>
    </div>
  </div>

  <script>
    const app = {
      data: { players: [], nights: [], archivedYears: {}, currentYear: new Date().getFullYear() },
      history: [],
      charts: {},
      currentSort: 'newest',
      token: null,

      init() {
        this.token = localStorage.getItem('github_token');
        if (!this.token) {
          const token = prompt('Enter your GitHub Personal Access Token (ghp_...)');
          if (token && token.startsWith('ghp_')) {
            localStorage.setItem('github_token', token);
            this.token = token;
          }
        }
        if (this.token) {
          this.loadFromGitHub().then(() => {
            this.render();
            this.sortNights(this.currentSort);
          });
        } else {
          this.loadLocal();
          this.render();
          this.sortNights(this.currentSort);
        }
      },

      updateSyncStatus(status, text) {
        document.getElementById('syncIndicator').className = 'sync-indicator ' + status;
        document.getElementById('syncText').textContent = text;
      },

      async loadFromGitHub() {
        this.updateSyncStatus('syncing', 'Loading...');
        try {
          const url = 'https://api.github.com/repos/vibeforlife/poker-tracker/contents/poker-data.json?ref=main';
          const response = await fetch(url, { headers: { 'Authorization': 'token ' + this.token }});
          if (response.ok) {
            const file = await response.json();
            this.data = JSON.parse(atob(file.content));
            this.data.sha = file.sha;
            this.updateSyncStatus('synced', 'Synced');
            localStorage.setItem('pokerTrackerData', JSON.stringify(this.data));
          }
        } catch (error) {
          this.updateSyncStatus('error', 'Failed');
          this.loadLocal();
        }
      },

      loadLocal() {
        const saved = localStorage.getItem('pokerTrackerData');
        if (saved) this.data = JSON.parse(saved);
      },

      async saveToGitHub() {
        if (!this.token) {
          localStorage.setItem('pokerTrackerData', JSON.stringify(this.data));
          return;
        }
        this.updateSyncStatus('syncing', 'Saving...');
        try {
          const content = btoa(JSON.stringify(this.data, null, 2));
          const body = { message: 'Update poker data', content, branch: 'main' };
          if (this.data.sha) body.sha = this.data.sha;
          const response = await fetch('https://api.github.com/repos/vibeforlife/poker-tracker/contents/poker-data.json', {
            method: 'PUT',
            headers: { 'Authorization': 'token ' + this.token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (response.ok) {
            const result = await response.json();
            this.data.sha = result.content.sha;
            this.updateSyncStatus('synced', 'Synced');
          }
        } catch (error) {
          this.updateSyncStatus('error', 'Failed');
        }
        localStorage.setItem('pokerTrackerData', JSON.stringify(this.data));
      },

      saveData() {
        clearTimeout(this.syncTimeout);
        this.syncTimeout = setTimeout(() => this.saveToGitHub(), 2000);
      },

      manualSync() { this.saveToGitHub(); },
      saveState() { this.history.push(JSON.stringify(this.data)); if (this.history.length > 30) this.history.shift(); },
      
      undo() {
        if (this.history.length === 0) { alert('Nothing to undo'); return; }
        this.data = JSON.parse(this.history.pop());
        this.saveData();
        this.render();
      },

      switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab).classList.add('active');
        if (tab === 'charts') this.renderCharts();
        if (tab === 'leaderboard') this.renderLeaderboard();
        if (tab === 'badges') this.renderBadges();
        if (tab === 'lifetime') this.renderLifetimeStats();
      },

      addPlayer() {
        const name = document.getElementById('newPlayerName').value.trim();
        const email = document.getElementById('newPlayerEmail').value.trim();
        if (!name) { alert('Enter name'); return; }
        if (this.data.players.some(p => p.name.toLowerCase() === name.toLowerCase())) { alert('Player exists'); return; }
        this.saveState();
        this.data.players.push({ id: Date.now(), name, email });
        document.getElementById('newPlayerName').value = '';
        document.getElementById('newPlayerEmail').value = '';
        this.saveData();
        this.render();
      },

      deletePlayer(id) {
        if (!confirm('Delete player?')) return;
        this.saveState();
        this.data.players = this.data.players.filter(p => p.id !== id);
        this.data.nights.forEach(n => n.attendees = n.attendees.filter(a => a.playerId !== id));
        this.saveData();
        this.render();
      },

      addNight() {
        const name = document.getElementById('newNightName').value.trim() || 'Poker Night';
        const date = document.getElementById('newNightDate').value;
        const time = document.getElementById('newNightTime').value || '19:00';
        const location = document.getElementById('newNightLocation').value.trim();
        if (!date) { alert('Select date'); return; }
        this.saveState();
        this.data.nights.push({ id: Date.now(), name, date, time, location, notes: '', attendees: [], buyIn: 20 });
        document.getElementById('newNightName').value = '';
        document.getElementById('newNightDate').value = '';
        document.getElementById('newNightTime').value = '';
        document.getElementById('newNightLocation').value = '';
        this.saveData();
        this.sortNights(this.currentSort);
        this.render();
      },

      deleteNight(id) {
        if (!confirm('Delete night?')) return;
        this.saveState();
        this.data.nights = this.data.nights.filter(n => n.id !== id);
        this.saveData();
        this.render();
      },

      sortNights(method) {
        this.currentSort = method;
        switch(method) {
          case 'newest': this.data.nights.sort((a, b) => new Date(b.date) - new Date(a.date)); break;
          case 'oldest': this.data.nights.sort((a, b) => new Date(a.date) - new Date(b.date)); break;
          case 'name': this.data.nights.sort((a, b) => (a.name || '').localeCompare(b.name || '')); break;
          case 'location': this.data.nights.sort((a, b) => (a.location || '').localeCompare(b.location || '')); break;
        }
        this.render();
      },

      closeYear() {
        if (!confirm('Close ' + this.data.currentYear + '?')) return;
        this.saveState();
        this.data.archivedYears[this.data.currentYear] = {
          players: JSON.parse(JSON.stringify(this.data.players)),
          nights: JSON.parse(JSON.stringify(this.data.nights))
        };
        this.data.nights = [];
        this.data.currentYear = new Date().getFullYear();
        this.saveData();
        this.render();
        alert('Year closed!');
      },

      exportData() {
        const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'poker-backup.json';
        a.click();
      },

      showQRCode() {
        const canvas = document.getElementById('qrCanvas');
        canvas.width = 300;
        canvas.height = 300;
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => canvas.getContext('2d').drawImage(img, 0, 0, 300, 300);
        img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent('https://vibeforlife.github.io/poker-tracker/poker-viewer.html');
        document.getElementById('qrModal').classList.add('active');
      },

      showHandRankings() {
        document.getElementById('handRankingsModal').classList.add('active');
      },

      editNight(id) {
        const night = this.data.nights.find(n => n.id === id);
        if (!night.notes) night.notes = '';
        
        let html = '<label>Name:</label><input type="text" id="editNightName" value="' + night.name + '">';
        html += '<div class="form-row"><div><label>Date:</label><input type="date" id="editNightDate" value="' + night.date + '"></div>';
        html += '<div><label>Time:</label><input type="time" id="editNightTime" value="' + (night.time || '19:00') + '"></div></div>';
        html += '<label>Location:</label><input type="text" id="editNightLocation" value="' + (night.location || '') + '">';
        html += '<label>Notes:</label><textarea id="editNightNotes" placeholder="Add notes...">' + night.notes + '</textarea>';
        html += '<label>Buy-In:</label><input type="number" id="editBuyIn" value="' + night.buyIn + '">';
        html += '<h3>Attendees</h3><input type="text" id="playerSearch" placeholder="Search..." onkeyup="app.filterPlayers()">';
        html += '<div class="checkbox-list" id="attendeeCheckboxes"></div>';
        html += '<h3>Results</h3><div id="attendeeResults"></div>';
        html += '<button class="btn btn-primary" onclick="app.saveNight(' + id + ')">Save</button>';
        html += '<button class="btn btn-secondary" onclick="app.calculateSettlement(' + id + ')">Settlement</button>';
        
        document.getElementById('editNightContent').innerHTML = html;
        
        const checkboxContainer = document.getElementById('attendeeCheckboxes');
        this.data.players.forEach(player => {
          const checked = night.attendees.some(a => a.playerId === player.id);
          const div = document.createElement('div');
          div.className = 'checkbox-item';
          div.innerHTML = '<label for="player_' + player.id + '">' + player.name + '</label><input type="checkbox" id="player_' + player.id + '" ' + (checked ? 'checked' : '') + '>';
          checkboxContainer.appendChild(div);
        });
        
        this.updateAttendeeResults(night);
        document.getElementById('editNightModal').classList.add('active');
      },

      filterPlayers() {
        const search = document.getElementById('playerSearch').value.toLowerCase();
        document.querySelectorAll('.checkbox-item').forEach(item => {
          const label = item.querySelector('label').textContent.toLowerCase();
          item.style.display = label.includes(search) ? 'flex' : 'none';
        });
      },

      updateAttendeeResults(night) {
        let html = '';
        night.attendees.forEach(attendee => {
          const player = this.data.players.find(p => p.id === attendee.playerId);
          if (!player) return;
          html += '<div class="attendee-input"><span>' + player.name + '</span>';
          html += '<input type="number" value="' + attendee.winnings + '" onchange="app.updateWinnings(' + night.id + ', ' + attendee.playerId + ', this.value)">';
          html += '<button class="btn btn-danger" onclick="app.removeAttendee(' + night.id + ', ' + attendee.playerId + ')">Remove</button></div>';
        });
        const total = night.attendees.reduce((sum, a) => sum + parseFloat(a.winnings || 0), 0);
        html += '<p><strong>Total: $' + total.toFixed(2) + '</strong></p>';
        document.getElementById('attendeeResults').innerHTML = html;
      },

      saveNight(id) {
        this.saveState();
        const night = this.data.nights.find(n => n.id === id);
        night.name = document.getElementById('editNightName').value.trim() || 'Poker Night';
        night.date = document.getElementById('editNightDate').value;
        night.time = document.getElementById('editNightTime').value || '19:00';
        night.location = document.getElementById('editNightLocation').value.trim();
        night.notes = document.getElementById('editNightNotes').value.trim();
        night.buyIn = parseFloat(document.getElementById('editBuyIn').value) || 20;
        
        const selectedIds = [];
        this.data.players.forEach(player => {
          const checkbox = document.getElementById('player_' + player.id);
          if (checkbox && checkbox.checked) {
            selectedIds.push(player.id);
            if (!night.attendees.some(a => a.playerId === player.id)) {
              night.attendees.push({ playerId: player.id, winnings: -night.buyIn });
            }
          }
        });
        night.attendees = night.attendees.filter(a => selectedIds.includes(a.playerId));
        this.saveData();
        this.updateAttendeeResults(night);
      },

      updateWinnings(nightId, playerId, value) {
        const night = this.data.nights.find(n => n.id === nightId);
        const attendee = night.attendees.find(a => a.playerId === playerId);
        attendee.winnings = parseFloat(value) || 0;
        this.saveData();
        this.updateAttendeeResults(night);
      },

      removeAttendee(nightId, playerId) {
        const night = this.data.nights.find(n => n.id === nightId);
        night.attendees = night.attendees.filter(a => a.playerId !== playerId);
        this.saveData();
        this.updateAttendeeResults(night);
      },

      calculateSettlement(nightId) {
        const night = this.data.nights.find(n => n.id === nightId);
        const balances = night.attendees.map(a => ({
          player: this.data.players.find(p => p.id === a.playerId).name,
          balance: a.winnings
        })).sort((a, b) => a.balance - b.balance);
        
        const transactions = [];
        const debtors = balances.filter(b => b.balance < 0).map(b => ({...b}));
        const creditors = balances.filter(b => b.balance > 0).map(b => ({...b}));
        
        debtors.forEach(debtor => {
          let remaining = -debtor.balance;
          creditors.forEach(creditor => {
            if (remaining > 0 && creditor.balance > 0) {
              const amount = Math.min(remaining, creditor.balance);
              transactions.push(debtor.player + ' pays ' + creditor.player + ': $' + amount.toFixed(2));
              remaining -= amount;
              creditor.balance -= amount;
            }
          });
        });
        
        document.getElementById('settlementContent').innerHTML = transactions.length > 0 ? transactions.join('<br>') : 'All settled!';
        document.getElementById('settlementModal').classList.add('active');
      },

      getPlayerStats(yearData) {
        const data = yearData || { players: this.data.players, nights: this.data.nights };
        return data.players.map(player => {
          const games = data.nights.filter(n => n.attendees.some(a => a.playerId === player.id)).length;
          const totalWinnings = data.nights.reduce((sum, night) => {
            const attendee = night.attendees.find(a => a.playerId === player.id);
            return sum + (attendee ? attendee.winnings : 0);
          }, 0);
          const avgWinnings = games > 0 ? totalWinnings / games : 0;
          return { id: player.id, name: player.name, games, totalWinnings, avgWinnings };
        });
      },

      getAchievements(stats, yearData) {
        const achievements = [];
        const data = yearData || { players: this.data.players, nights: this.data.nights };
        const allStats = this.getPlayerStats(yearData);
        const maxWinnings = Math.max(...allStats.map(s => s.totalWinnings));
        if (stats.totalWinnings === maxWinnings && maxWinnings > 0) achievements.push('üèÜ Top Earner YTD');
        
        const playerNights = data.nights.filter(n => n.attendees.some(a => a.playerId === stats.id)).sort((a, b) => new Date(a.date) - new Date(b.date));
        let streak = 0, maxStreak = 0;
        playerNights.forEach(night => {
          const attendee = night.attendees.find(a => a.playerId === stats.id);
          if (attendee.winnings > 0) { streak++; maxStreak = Math.max(maxStreak, streak); } else streak = 0;
        });
        if (maxStreak >= 3) achievements.push('üî• Hot Streak');
        
        const maxWin = Math.max(...playerNights.map(n => {
          const a = n.attendees.find(at => at.playerId === stats.id);
          return a ? a.winnings : -Infinity;
        }), 0);
        if (maxWin >= 100) achievements.push('üíé High Roller');
        if (stats.games >= 5) achievements.push('üéÆ Regular Player');
        if (stats.games >= 20) achievements.push('üåü Veteran');
        if (stats.games >= 50) achievements.push('üíØ Half Century');
        if (stats.totalWinnings >= 100) achievements.push('üíµ $100 Club');
        if (stats.totalWinnings >= 500) achievements.push('üíé $500 Club');
        return achievements;
      },

      showPlayerProfile(playerId) {
        const player = this.data.players.find(p => p.id === playerId);
        const stats = this.getPlayerStats().find(s => s.id === playerId);
        const achievements = this.getAchievements(stats);
        document.getElementById('playerProfileName').textContent = player.name;
        
        let html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">';
        html += '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 2em; font-weight: bold; color: #f39c12;">' + stats.games + '</div><div style="font-size: 0.9em; color: #aaa;">Games</div></div>';
        html += '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 2em; font-weight: bold; color: #f39c12;">$' + stats.totalWinnings.toFixed(2) + '</div><div style="font-size: 0.9em; color: #aaa;">Total</div></div>';
        html += '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 2em; font-weight: bold; color: #f39c12;">$' + stats.avgWinnings.toFixed(2) + '</div><div style="font-size: 0.9em; color: #aaa;">Avg</div></div>';
        html += '</div><h3>Achievements</h3><div>' + achievements.map(a => '<span class="achievement">' + a + '</span>').join('') + '</div>';
        
        document.getElementById('playerProfileContent').innerHTML = html;
        document.getElementById('playerProfileModal').classList.add('active');
      },

      renderLeaderboard() {
        const stats = this.getPlayerStats().sort((a, b) => b.totalWinnings - a.totalWinnings);
        let html = '';
        stats.forEach((s, i) => {
          const achievements = this.getAchievements(s);
          html += '<div class="item-card" onclick="app.showPlayerProfile(' + s.id + ')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">';
          html += '<div><strong style="font-size: 1.1em;">' + (i + 1) + '. ' + s.name + '</strong><div style="margin-top: 5px;">';
          html += achievements.map(a => '<span class="achievement">' + a + '</span>').join('');
          html += '</div></div><div style="text-align: right;">';
          html += '<div style="font-size: 1.5em; font-weight: bold; color: ' + (s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + s.totalWinnings.toFixed(2) + '</div>';
          html += '<div style="font-size: 0.9em; color: #aaa;">' + s.games + ' games ‚Ä¢ $' + s.avgWinnings.toFixed(2) + ' avg</div>';
          html += '</div></div>';
        });
        document.getElementById('leaderboardList').innerHTML = html;
      },

      renderCharts() {
        const stats = this.getPlayerStats().sort((a, b) => b.totalWinnings - a.totalWinnings);
        const ctx1 = document.getElementById('totalWinningsChart');
        if (this.charts.total) this.charts.total.destroy();
        this.charts.total = new Chart(ctx1, {
          type: 'bar',
          data: { labels: stats.map(s => s.name), datasets: [{ data: stats.map(s => s.totalWinnings), backgroundColor: stats.map(s => s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c') }]},
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const ctx2 = document.getElementById('gamesPlayedChart');
        if (this.charts.games) this.charts.games.destroy();
        this.charts.games = new Chart(ctx2, {
          type: 'bar',
          data: { labels: stats.map(s => s.name), datasets: [{ data: stats.map(s => s.games), backgroundColor: '#f39c12' }]},
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
        const ctx3 = document.getElementById('avgWinningsChart');
        if (this.charts.avg) this.charts.avg.destroy();
        this.charts.avg = new Chart(ctx3, {
          type: 'line',
          data: { labels: stats.map(s => s.name), datasets: [{ data: stats.map(s => s.avgWinnings), borderColor: '#9b59b6', tension: 0.4 }]},
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      },

      renderBadges() {
        const badgeDefs = [
          { badge: 'üèÜ Top Earner YTD', desc: 'Highest total winnings this year', color: '#f39c12' },
          { badge: 'üî• Hot Streak', desc: 'Won 3 or more games in a row', color: '#e74c3c' },
          { badge: 'üíé High Roller', desc: 'Single night win of $100 or more', color: '#3498db' },
          { badge: 'üéÆ Regular Player', desc: 'Played 5 or more games', color: '#9b59b6' },
          { badge: 'üåü Veteran', desc: 'Played 20 or more games', color: '#f39c12' },
          { badge: 'üíØ Half Century', desc: 'Played 50 or more games', color: '#2ecc71' },
          { badge: 'üíµ $100 Club', desc: 'Total winnings of $100 or more', color: '#27ae60' },
          { badge: 'üíé $500 Club', desc: 'Total winnings of $500 or more', color: '#16a085' }
        ];
        const stats = this.getPlayerStats();
        const holders = {};
        stats.forEach(s => {
          this.getAchievements(s).forEach(badge => {
            if (!holders[badge]) holders[badge] = [];
            holders[badge].push(s.name);
          });
        });
        let html = '';
        badgeDefs.forEach(def => {
          const names = holders[def.badge] || [];
          html += '<div class="badge-card" style="border-left-color: ' + def.color + ';">';
          html += '<div class="badge-header">' + def.badge + '</div>';
          html += '<div class="badge-desc">' + def.desc + '</div>';
          html += '<div class="badge-divider"></div>';
          html += '<div style="font-size: 0.9em; color: #888; margin-bottom: 10px;">üèÖ ' + names.length + ' player' + (names.length !== 1 ? 's' : '') + ' earned</div>';
          html += '<div class="badge-players">';
          html += names.length > 0 ? names.map(n => '<span class="badge-player-tag">üë§ ' + n + '</span>').join('') : '<span class="badge-empty">No one yet. Be the first!</span>';
          html += '</div></div>';
        });
        document.getElementById('badgesList').innerHTML = html;
      },

      renderLifetimeStats() {
        const lifetime = {};
        this.data.players.forEach(p => { lifetime[p.id] = { name: p.name, games: 0, winnings: 0 }; });
        
        Object.values(this.data.archivedYears || {}).forEach(year => {
          this.getPlayerStats(year).forEach(s => {
            if (lifetime[s.id]) {
              lifetime[s.id].games += s.games;
              lifetime[s.id].winnings += s.totalWinnings;
            }
          });
        });
        
        this.getPlayerStats().forEach(s => {
          if (lifetime[s.id]) {
            lifetime[s.id].games += s.games;
            lifetime[s.id].winnings += s.totalWinnings;
          }
        });
        
        const sorted = Object.values(lifetime).filter(s => s.games > 0).sort((a, b) => b.winnings - a.winnings);
        let html = '';
        sorted.forEach((s, i) => {
          html += '<div class="item-card" style="display: flex; justify-content: space-between; align-items: center;">';
          html += '<div><strong style="font-size: 1.1em;">' + (i + 1) + '. ' + s.name + '</strong></div>';
          html += '<div style="text-align: right;"><div style="font-size: 1.5em; font-weight: bold; color: ' + (s.winnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + s.winnings.toFixed(2) + '</div>';
          html += '<div style="font-size: 0.9em; color: #aaa;">' + s.games + ' games ‚Ä¢ $' + (s.winnings / s.games).toFixed(2) + ' avg</div></div></div>';
        });
        document.getElementById('lifetimeLeaderboard').innerHTML = html;
        
        const years = [...new Set([...Object.keys(this.data.archivedYears || {}), this.data.currentYear.toString()])].sort((a, b) => b - a);
        let yearHtml = '';
        years.forEach(year => {
          const yearData = year == this.data.currentYear ? { players: this.data.players, nights: this.data.nights } : this.data.archivedYears[year];
          if (!yearData || !yearData.nights || yearData.nights.length === 0) return;
          const yearStats = this.getPlayerStats(yearData).sort((a, b) => b.totalWinnings - a.totalWinnings);
          const topPlayer = yearStats[0];
          
          yearHtml += '<div class="item-card" style="display: flex; justify-content: space-between; align-items: center;">';
          yearHtml += '<div><strong style="font-size: 1.1em;">' + year + ' ' + (year == this.data.currentYear ? '(Current)' : '') + '</strong>';
          yearHtml += '<div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">Games: ' + yearData.nights.length + '</div></div>';
          yearHtml += '<div style="text-align: right;">';
          if (topPlayer) {
            yearHtml += '<div style="font-size: 1.2em; color: #f39c12; font-weight: bold;">' + topPlayer.name + '</div>';
            yearHtml += '<div style="font-size: 0.9em; color: #2ecc71;">$' + topPlayer.totalWinnings.toFixed(2) + '</div>';
          }
          yearHtml += '</div></div>';
        });
        document.getElementById('yearByYearStats').innerHTML = yearHtml;
      },

      closeModal(id) {
        document.getElementById(id).classList.remove('active');
      },

      render() {
        let playersHtml = '';
        this.data.players.forEach(p => {
          playersHtml += '<div class="player-item"><div><strong>' + p.name + '</strong>';
          if (p.email) playersHtml += '<div style="font-size: 0.9em; color: #aaa;">' + p.email + '</div>';
          playersHtml += '</div><button class="btn btn-danger" onclick="app.deletePlayer(' + p.id + ')">Delete</button></div>';
        });
        document.getElementById('playersList').innerHTML = playersHtml;
        
        let nightsHtml = '';
        this.data.nights.forEach(n => {
          nightsHtml += '<div class="night-item"><div class="night-header"><div><h3>' + n.name + '</h3>';
          nightsHtml += '<div style="font-size: 0.9em; color: #aaa;">üìÖ ' + n.date + (n.time ? ' ‚Ä¢ üïê ' + n.time : '');
          if (n.location) nightsHtml += '<br>üìç ' + n.location;
          nightsHtml += '<br>üë• ' + n.attendees.length + ' attendees</div>';
          if (n.notes) nightsHtml += '<div class="notes-display">üìù "' + n.notes + '"</div>';
          nightsHtml += '</div><div><button class="btn btn-primary" onclick="app.editNight(' + n.id + ')">Edit</button>';
          nightsHtml += '<button class="btn btn-danger" onclick="app.deleteNight(' + n.id + ')">Delete</button></div></div></div>';
        });
        document.getElementById('nightsList').innerHTML = nightsHtml;
        this.renderLeaderboard();
      }
    };

    app.init();
  </script>
</body>
</html>