<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fold and Furious - Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e4e4e4; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 2.5em; background: linear-gradient(45deg, #f39c12, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { text-align: center; color: #aaa; margin-bottom: 30px; }
    .refresh-btn { background: #3a3a50; color: #e4e4e4; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 0 5px; }
    .refresh-btn:hover { background: #4a4a60; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    .tab { padding: 12px 24px; background: #2a2a40; border: none; border-radius: 8px; color: #e4e4e4; cursor: pointer; font-size: 16px; }
    .tab:hover { background: #3a3a50; }
    .tab.active { background: linear-gradient(45deg, #f39c12, #e74c3c); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: #2a2a40; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
    
    .item-card { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.3s; }
    .item-card:hover { background: #2a2a3e; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    
    .night-item { background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.3s; }
    .night-item:hover { background: #2a2a3e; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
    .night-header { display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px; }
    .notes-display { font-size: 0.9em; color: #aaa; margin-top: 8px; font-style: italic; padding: 8px; background: #2a2a40; border-radius: 6px; }
    
    .achievement { display: inline-block; padding: 5px 10px; background: linear-gradient(45deg, #f39c12, #e74c3c); border-radius: 20px; margin: 5px; font-size: 12px; }
    
    .badge-card { background: linear-gradient(135deg, #2a2a40 0%, #1a1a2e 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #f39c12; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); transition: transform 0.3s; }
    .badge-card:hover { transform: translateX(5px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4); }
    .badge-header { font-size: 2em; margin-bottom: 15px; }
    .badge-desc { color: #bbb; font-size: 1.1em; margin-bottom: 15px; }
    .badge-divider { height: 1px; background: linear-gradient(90deg, transparent, #f39c12, transparent); margin: 15px 0; }
    .badge-players { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .badge-player-tag { background: linear-gradient(45deg, #3a3a50, #2a2a40); padding: 8px 16px; border-radius: 20px; font-size: 0.95em; border: 1px solid #4a4a60; transition: all 0.3s; }
    .badge-player-tag:hover { background: linear-gradient(45deg, #4a4a60, #3a3a50); transform: scale(1.05); }
    .badge-empty { color: #666; font-style: italic; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; padding: 20px; overflow-y: auto; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #2a2a40; border-radius: 12px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
    .btn-secondary { background: #3a3a50; color: #e4e4e4; }
    .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #aaa; }
    .error { text-align: center; padding: 40px; color: #e74c3c; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üÉè Fold and Furious</h1>
    <p class="subtitle">
      üìñ Read-Only View ‚Ä¢ 
      <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
      <button class="refresh-btn" onclick="showHandRankings()">üÉè Poker Hands</button>
    </p>

    <div id="loadingState" class="loading">Loading poker data...</div>
    <div id="errorState" class="error" style="display: none;">Unable to load data.</div>

    <div id="appContent" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('nights')">Nights</button>
        <button class="tab" onclick="switchTab('leaderboard')">Leaderboard</button>
        <button class="tab" onclick="switchTab('charts')">Charts</button>
        <button class="tab" onclick="switchTab('badges')">Badges</button>
        <button class="tab" onclick="switchTab('lifetime')">Lifetime</button>
      </div>

      <div id="nights" class="tab-content active">
        <div class="card">
          <h2>üìÖ Recent Poker Nights</h2>
          <div id="nightsList"></div>
        </div>
      </div>

      <div id="leaderboard" class="tab-content">
        <div class="card">
          <h2>üèÜ Leaderboard</h2>
          <div id="leaderboardList"></div>
        </div>
      </div>

      <div id="charts" class="tab-content">
        <div class="card"><h2>Total Winnings</h2><div style="height: 300px; position: relative;"><canvas id="totalWinningsChart"></canvas></div></div>
        <div class="card"><h2>Games Played</h2><div style="height: 300px; position: relative;"><canvas id="gamesPlayedChart"></canvas></div></div>
        <div class="card"><h2>Average Winnings</h2><div style="height: 300px; position: relative;"><canvas id="avgWinningsChart"></canvas></div></div>
      </div>

      <div id="badges" class="tab-content">
        <div class="card"><h2>üèÖ All Badges</h2><div id="badgesList"></div></div>
      </div>

      <div id="lifetime" class="tab-content">
        <div class="card"><h2>üåü Lifetime Leaderboard</h2><div id="lifetimeLeaderboard"></div></div>
        <div class="card"><h2>üìÖ Year by Year</h2><div id="yearByYearStats"></div></div>
      </div>
    </div>
  </div>

  <div id="playerProfileModal" class="modal">
    <div class="modal-content">
      <h2 id="playerProfileName"></h2>
      <div id="playerProfileContent"></div>
      <button class="btn btn-secondary" onclick="closeModal('playerProfileModal')">Close</button>
    </div>
  </div>

  <div id="nightDetailModal" class="modal">
    <div class="modal-content">
      <h2 id="nightDetailName"></h2>
      <div id="nightDetailContent"></div>
      <button class="btn btn-secondary" onclick="closeModal('nightDetailModal')">Close</button>
    </div>
  </div>

  <div id="handRankingsModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <h2>üÉè Poker Hand Rankings</h2>
      <img src="https://raw.githubusercontent.com/vibeforlife/poker-tracker/main/poker%20hand%20rankings.jpg" style="max-width: 100%; border-radius: 8px; margin: 20px 0;">
      <button class="btn btn-secondary" onclick="closeModal('handRankingsModal')">Close</button>
    </div>
  </div>

  <script>
    var appData = null;
    var charts = {};
    var DATA_URL = 'https://api.github.com/repos/vibeforlife/poker-tracker/contents/poker-data.json?ref=main';

    function loadData() {
      fetch(DATA_URL)
        .then(function(response) {
          if (!response.ok) throw new Error('Failed');
          return response.json();
        })
        .then(function(file) {
          appData = JSON.parse(atob(file.content));
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('appContent').style.display = 'block';
          renderNights();
          renderLeaderboard();
        })
        .catch(function(error) {
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('errorState').style.display = 'block';
        });
    }

    function refreshData() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('appContent').style.display = 'none';
      loadData();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
      event.target.classList.add('active');
      document.getElementById(tab).classList.add('active');
      if (tab === 'charts') renderCharts();
      if (tab === 'badges') renderBadges();
      if (tab === 'lifetime') renderLifetimeStats();
      if (tab === 'nights') renderNights();
    }

    function renderNights() {
      var nights = appData.nights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
      var html = '';
      
      nights.forEach(function(n) {
        html += '<div class="night-item" onclick="showNightDetail(' + n.id + ')" style="cursor: pointer;">';
        html += '<div class="night-header"><div><h3>' + n.name + '</h3>';
        html += '<div style="font-size: 0.9em; color: #aaa;">üìÖ ' + n.date + (n.time ? ' ‚Ä¢ üïê ' + n.time : '');
        if (n.location) html += '<br>üìç ' + n.location;
        html += '<br>üë• ' + n.attendees.length + ' attendees</div>';
        if (n.notes) html += '<div class="notes-display">üìù "' + n.notes + '"</div>';
        html += '</div></div></div>';
      });
      
      document.getElementById('nightsList').innerHTML = html || '<p style="color: #888;">No poker nights yet</p>';
    }

    function showNightDetail(nightId) {
      var night = appData.nights.find(function(n) { return n.id === nightId; });
      if (!night) return;
      
      document.getElementById('nightDetailName').textContent = night.name;
      
      var html = '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
      html += '<p><strong>üìÖ Date:</strong> ' + night.date + '</p>';
      if (night.time) html += '<p><strong>üïê Time:</strong> ' + night.time + '</p>';
      if (night.location) html += '<p><strong>üìç Location:</strong> ' + night.location + '</p>';
      if (night.notes) html += '<p style="margin-top: 10px;"><strong>üìù Notes:</strong><br><em style="color: #aaa;">' + night.notes + '</em></p>';
      html += '</div>';
      
      html += '<h3>Results</h3><div style="margin-top: 10px;">';
      var sorted = night.attendees.slice().sort(function(a, b) { return b.winnings - a.winnings; });
      sorted.forEach(function(a, i) {
        var player = appData.players.find(function(p) { return p.id === a.playerId; });
        if (!player) return;
        var rank = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.';
        html += '<div style="display: flex; justify-content: space-between; padding: 10px; background: #2a2a40; margin: 5px 0; border-radius: 6px;">';
        html += '<span>' + rank + ' ' + player.name + '</span>';
        html += '<span style="font-weight: bold; color: ' + (a.winnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + a.winnings.toFixed(2) + '</span>';
        html += '</div>';
      });
      html += '</div>';
      
      document.getElementById('nightDetailContent').innerHTML = html;
      document.getElementById('nightDetailModal').classList.add('active');
    }

    function getPlayerStats(yearData) {
      var data = yearData || { players: appData.players, nights: appData.nights };
      return data.players.map(function(player) {
        var games = data.nights.filter(function(n) {
          return n.attendees.some(function(a) { return a.playerId === player.id; });
        }).length;
        var totalWinnings = data.nights.reduce(function(sum, night) {
          var attendee = night.attendees.find(function(a) { return a.playerId === player.id; });
          return sum + (attendee ? attendee.winnings : 0);
        }, 0);
        var avgWinnings = games > 0 ? totalWinnings / games : 0;
        return { id: player.id, name: player.name, games: games, totalWinnings: totalWinnings, avgWinnings: avgWinnings };
      });
    }

    function getAchievements(stats, yearData) {
      var achievements = [];
      var data = yearData || { players: appData.players, nights: appData.nights };
      var allStats = getPlayerStats(yearData);
      var maxWinnings = Math.max.apply(Math, allStats.map(function(s) { return s.totalWinnings; }));
      if (stats.totalWinnings === maxWinnings && maxWinnings > 0) achievements.push('üèÜ Top Earner YTD');
      
      var playerNights = data.nights.filter(function(n) {
        return n.attendees.some(function(a) { return a.playerId === stats.id; });
      }).sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
      
      var streak = 0, maxStreak = 0;
      playerNights.forEach(function(night) {
        var attendee = night.attendees.find(function(a) { return a.playerId === stats.id; });
        if (attendee && attendee.winnings > 0) { 
          streak++; 
          maxStreak = Math.max(maxStreak, streak); 
        } else {
          streak = 0;
        }
      });
      if (maxStreak >= 3) achievements.push('üî• Hot Streak');
      
      var wins = playerNights.map(function(n) {
        var a = n.attendees.find(function(at) { return at.playerId === stats.id; });
        return a ? a.winnings : -Infinity;
      });
      var maxWin = wins.length > 0 ? Math.max.apply(Math, wins) : 0;
      if (maxWin >= 100) achievements.push('üíé High Roller');
      
      if (stats.games >= 5) achievements.push('üéÆ Regular Player');
      if (stats.games >= 20) achievements.push('üåü Veteran');
      if (stats.games >= 50) achievements.push('üíØ Half Century');
      if (stats.totalWinnings >= 100) achievements.push('üíµ $100 Club');
      if (stats.totalWinnings >= 500) achievements.push('üíé $500 Club');
      
      return achievements;
    }

    function showPlayerProfile(playerId) {
      var player = appData.players.find(function(p) { return p.id === playerId; });
      var stats = getPlayerStats().find(function(s) { return s.id === playerId; });
      var achievements = getAchievements(stats);
      
      document.getElementById('playerProfileName').textContent = player.name;
      
      var html = '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">';
      html += '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 2em; font-weight: bold; color: #f39c12;">' + stats.games + '</div><div style="font-size: 0.9em; color: #aaa;">Games</div></div>';
      html += '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 2em; font-weight: bold; color: #f39c12;">$' + stats.totalWinnings.toFixed(2) + '</div><div style="font-size: 0.9em; color: #aaa;">Total</div></div>';
      html += '<div style="background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center;"><div style="font-size: 2em; font-weight: bold; color: #f39c12;">$' + stats.avgWinnings.toFixed(2) + '</div><div style="font-size: 0.9em; color: #aaa;">Avg</div></div>';
      html += '</div><h3>Achievements</h3><div style="margin: 15px 0;">';
      html += achievements.map(function(a) { return '<span class="achievement">' + a + '</span>'; }).join('');
      if (achievements.length === 0) html += '<p style="color: #888;">No achievements yet</p>';
      html += '</div>';
      
      document.getElementById('playerProfileContent').innerHTML = html;
      document.getElementById('playerProfileModal').classList.add('active');
    }

    function renderLeaderboard() {
      var stats = getPlayerStats().sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
      var html = '';
      
      stats.forEach(function(s, i) {
        var achievements = getAchievements(s);
        html += '<div class="item-card" onclick="showPlayerProfile(' + s.id + ')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">';
        html += '<div><strong style="font-size: 1.1em;">' + (i + 1) + '. ' + s.name + '</strong><div style="margin-top: 5px;">';
        html += achievements.map(function(a) { return '<span class="achievement">' + a + '</span>'; }).join('');
        html += '</div></div><div style="text-align: right;">';
        html += '<div style="font-size: 1.5em; font-weight: bold; color: ' + (s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + s.totalWinnings.toFixed(2) + '</div>';
        html += '<div style="font-size: 0.9em; color: #aaa;">' + s.games + ' games ‚Ä¢ $' + s.avgWinnings.toFixed(2) + ' avg</div>';
        html += '</div></div>';
      });
      
      document.getElementById('leaderboardList').innerHTML = html;
    }

    function renderCharts() {
      var stats = getPlayerStats().sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
      
      var ctx1 = document.getElementById('totalWinningsChart');
      if (charts.total) charts.total.destroy();
      charts.total = new Chart(ctx1, {
        type: 'bar',
        data: { labels: stats.map(function(s) { return s.name; }), datasets: [{ data: stats.map(function(s) { return s.totalWinnings; }), backgroundColor: stats.map(function(s) { return s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c'; }) }]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
      
      var ctx2 = document.getElementById('gamesPlayedChart');
      if (charts.games) charts.games.destroy();
      charts.games = new Chart(ctx2, {
        type: 'bar',
        data: { labels: stats.map(function(s) { return s.name; }), datasets: [{ data: stats.map(function(s) { return s.games; }), backgroundColor: '#f39c12' }]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
      
      var ctx3 = document.getElementById('avgWinningsChart');
      if (charts.avg) charts.avg.destroy();
      charts.avg = new Chart(ctx3, {
        type: 'line',
        data: { labels: stats.map(function(s) { return s.name; }), datasets: [{ data: stats.map(function(s) { return s.avgWinnings; }), borderColor: '#9b59b6', tension: 0.4 }]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }

    function renderBadges() {
      var badgeDefs = [
        { badge: 'üèÜ Top Earner YTD', desc: 'Highest total winnings this year', color: '#f39c12' },
        { badge: 'üî• Hot Streak', desc: 'Won 3 or more games in a row', color: '#e74c3c' },
        { badge: 'üíé High Roller', desc: 'Single night win of $100 or more', color: '#3498db' },
        { badge: 'üéÆ Regular Player', desc: 'Played 5 or more games', color: '#9b59b6' },
        { badge: 'üåü Veteran', desc: 'Played 20 or more games', color: '#f39c12' },
        { badge: 'üíØ Half Century', desc: 'Played 50 or more games', color: '#2ecc71' },
        { badge: 'üíµ $100 Club', desc: 'Total winnings of $100 or more', color: '#27ae60' },
        { badge: 'üíé $500 Club', desc: 'Total winnings of $500 or more', color: '#16a085' }
      ];
      
      var stats = getPlayerStats();
      var holders = {};
      stats.forEach(function(s) {
        getAchievements(s).forEach(function(badge) {
          if (!holders[badge]) holders[badge] = [];
          holders[badge].push(s.name);
        });
      });
      
      var html = '';
      badgeDefs.forEach(function(def) {
        var names = holders[def.badge] || [];
        html += '<div class="badge-card" style="border-left-color: ' + def.color + ';">';
        html += '<div class="badge-header">' + def.badge + '</div>';
        html += '<div class="badge-desc">' + def.desc + '</div>';
        html += '<div class="badge-divider"></div>';
        html += '<div style="font-size: 0.9em; color: #888; margin-bottom: 10px;">üèÖ ' + names.length + ' player' + (names.length !== 1 ? 's' : '') + ' earned</div>';
        html += '<div class="badge-players">';
        html += names.length > 0 ? names.map(function(n) { return '<span class="badge-player-tag">üë§ ' + n + '</span>'; }).join('') : '<span class="badge-empty">No one yet. Be the first!</span>';
        html += '</div></div>';
      });
      
      document.getElementById('badgesList').innerHTML = html;
    }

    function renderLifetimeStats() {
      var lifetime = {};
      appData.players.forEach(function(p) { lifetime[p.id] = { name: p.name, games: 0, winnings: 0 }; });
      
      Object.values(appData.archivedYears || {}).forEach(function(year) {
        getPlayerStats(year).forEach(function(s) {
          if (lifetime[s.id]) {
            lifetime[s.id].games += s.games;
            lifetime[s.id].winnings += s.totalWinnings;
          }
        });
      });
      
      getPlayerStats().forEach(function(s) {
        if (lifetime[s.id]) {
          lifetime[s.id].games += s.games;
          lifetime[s.id].winnings += s.totalWinnings;
        }
      });
      
      var sorted = Object.values(lifetime).filter(function(s) { return s.games > 0; }).sort(function(a, b) { return b.winnings - a.winnings; });
      var html = '';
      sorted.forEach(function(s, i) {
        html += '<div class="item-card" style="display: flex; justify-content: space-between; align-items: center;">';
        html += '<div><strong style="font-size: 1.1em;">' + (i + 1) + '. ' + s.name + '</strong></div>';
        html += '<div style="text-align: right;"><div style="font-size: 1.5em; font-weight: bold; color: ' + (s.winnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + s.winnings.toFixed(2) + '</div>';
        html += '<div style="font-size: 0.9em; color: #aaa;">' + s.games + ' games ‚Ä¢ $' + (s.winnings / s.games).toFixed(2) + ' avg</div></div></div>';
      });
      document.getElementById('lifetimeLeaderboard').innerHTML = html;
      
      var years = Object.keys(appData.archivedYears || {}).concat([appData.currentYear.toString()]).sort(function(a, b) { return b - a; });
      var yearHtml = '';
      years.forEach(function(year) {
        var yearData = year == appData.currentYear ? { players: appData.players, nights: appData.nights } : appData.archivedYears[year];
        if (!yearData || !yearData.nights || yearData.nights.length === 0) return;
        var yearStats = getPlayerStats(yearData).sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
        var topPlayer = yearStats[0];
        
        yearHtml += '<div class="item-card" style="display: flex; justify-content: space-between; align-items: center;">';
        yearHtml += '<div><strong style="font-size: 1.1em;">' + year + ' ' + (year == appData.currentYear ? '(Current)' : '') + '</strong>';
        yearHtml += '<div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">Games: ' + yearData.nights.length + '</div></div>';
        yearHtml += '<div style="text-align: right;">';
        if (topPlayer) {
          yearHtml += '<div style="font-size: 1.2em; color: #f39c12; font-weight: bold;">' + topPlayer.name + '</div>';
          yearHtml += '<div style="font-size: 0.9em; color: #2ecc71;">$' + topPlayer.totalWinnings.toFixed(2) + '</div>';
        }
        yearHtml += '</div></div>';
      });
      document.getElementById('yearByYearStats').innerHTML = yearHtml;
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showHandRankings() {
      document.getElementById('handRankingsModal').classList.add('active');
    }

    loadData();
  </script>
</body>
</html>