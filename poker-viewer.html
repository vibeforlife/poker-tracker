<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fold and Furious Poker Tracker - Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e4e4e4; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 2.5em; background: linear-gradient(45deg, #f39c12, #e74c3c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .subtitle { text-align: center; color: #aaa; margin-bottom: 30px; font-size: 0.9em; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    .tab { padding: 12px 24px; background: #2a2a40; border: none; border-radius: 8px; color: #e4e4e4; cursor: pointer; transition: all 0.3s; font-size: 16px; }
    .tab:hover { background: #3a3a50; }
    .tab.active { background: linear-gradient(45deg, #f39c12, #e74c3c); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: #2a2a40; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
    .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1a1a2e; margin: 10px 0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .leaderboard-item:hover { background: #2a2a3e; transform: translateX(5px); }
    .achievement { display: inline-block; padding: 5px 10px; background: linear-gradient(45deg, #f39c12, #e74c3c); border-radius: 20px; margin: 5px; font-size: 12px; animation: pop 0.5s ease; }
    @keyframes pop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: #1a1a2e; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 2em; font-weight: bold; color: #f39c12; }
    .stat-label { font-size: 0.9em; color: #aaa; margin-top: 5px; }
    .chart-container { position: relative; height: 300px; margin: 20px 0; }
    .badge-card { background: #1a1a2e; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
    .badge-header { font-size: 1.5em; margin-bottom: 10px; }
    .badge-players { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .badge-player-tag { background: #2a2a40; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; }
    .year-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; padding: 20px; overflow-y: auto; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #2a2a40; border-radius: 12px; padding: 30px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; margin: 5px; }
    .btn-secondary { background: #3a3a50; color: #e4e4e4; }
    .btn-secondary:hover { background: #4a4a60; }
    select { padding: 10px; border: 1px solid #3a3a50; border-radius: 8px; background: #1a1a2e; color: #e4e4e4; font-size: 14px; }
    .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #aaa; }
    .error { text-align: center; padding: 40px; color: #e74c3c; }
    @media (max-width: 768px) { h1 { font-size: 1.8em; } .tabs { justify-content: center; } .tab { flex: 1; min-width: 120px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>üÉè Fold and Furious Poker Tracker</h1>
    <p class="subtitle">üìñ Read-Only View ‚Ä¢ <button class="btn btn-secondary" onclick="refreshData()" style="display: inline-block; padding: 5px 15px; margin: 0;">üîÑ Refresh</button></p>

    <div id="loadingState" class="loading">Loading poker data...</div>
    <div id="errorState" class="error" style="display: none;">Unable to load data. Please check connection.</div>

    <div id="appContent" style="display: none;">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('leaderboard')">Leaderboard</button>
        <button class="tab" onclick="switchTab('charts')">Charts</button>
        <button class="tab" onclick="switchTab('badges')">Badges</button>
        <button class="tab" onclick="switchTab('lifetime')">Lifetime Stats</button>
      </div>

      <div id="leaderboard" class="tab-content active">
        <div class="year-selector">
          <label>View Year:</label>
          <select id="leaderboardYearSelect" onchange="renderLeaderboard()">
            <option value="current">Current Year</option>
          </select>
        </div>
        <div class="card">
          <h2>üèÜ Leaderboard</h2>
          <div id="leaderboardList"></div>
        </div>
      </div>

      <div id="charts" class="tab-content">
        <div class="year-selector">
          <label>View Year:</label>
          <select id="chartsYearSelect" onchange="renderCharts()">
            <option value="current">Current Year</option>
          </select>
        </div>
        <div class="card">
          <h2>Total Winnings</h2>
          <div class="chart-container">
            <canvas id="totalWinningsChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h2>Games Played</h2>
          <div class="chart-container">
            <canvas id="gamesPlayedChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h2>Average Winnings</h2>
          <div class="chart-container">
            <canvas id="avgWinningsChart"></canvas>
          </div>
        </div>
      </div>

      <div id="badges" class="tab-content">
        <div class="card">
          <h2>üèÖ All Badges</h2>
          <div id="badgesList"></div>
        </div>
      </div>

      <div id="lifetime" class="tab-content">
        <div class="card">
          <h2>üåü Lifetime Leaderboard</h2>
          <div id="lifetimeLeaderboard"></div>
        </div>
        <div class="card">
          <h2>Year by Year</h2>
          <div id="yearByYearStats"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="playerProfileModal" class="modal">
    <div class="modal-content">
      <h2 id="playerProfileName"></h2>
      <div id="playerProfileContent"></div>
      <div class="chart-container">
        <canvas id="playerHistoryChart"></canvas>
      </div>
      <button class="btn btn-secondary" onclick="closeModal('playerProfileModal')">Close</button>
    </div>
  </div>

  <script>
    var appData = null;
    var charts = {};
    var DATA_URL = 'https://raw.githubusercontent.com/vibeforlife/poker-tracker/main/poker-data.json';

    function loadData() {
      // Add cache-busting timestamp
      var cacheBuster = '?t=' + new Date().getTime();
      fetch(DATA_URL + cacheBuster)
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to fetch');
          return response.json();
        })
        .then(function(data) {
          appData = data;
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('appContent').style.display = 'block';
          populateYearSelectors();
          renderLeaderboard();
        })
        .catch(function(error) {
          console.error('Error:', error);
          document.getElementById('loadingState').style.display = 'none';
          document.getElementById('errorState').style.display = 'block';
        });
    }

    function populateYearSelectors() {
      var years = Object.keys(appData.archivedYears || {}).sort(function(a, b) { return b - a; });
      ['leaderboardYearSelect', 'chartsYearSelect'].forEach(function(selectId) {
        var select = document.getElementById(selectId);
        select.innerHTML = '<option value="current">Current Year (' + appData.currentYear + ')</option>';
        years.forEach(function(year) {
          select.innerHTML += '<option value="' + year + '">' + year + '</option>';
        });
      });
    }

    function getYearData(year) {
      if (year === 'current') return { players: appData.players, nights: appData.nights };
      return appData.archivedYears[year] || { players: [], nights: [] };
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
      event.target.classList.add('active');
      document.getElementById(tab).classList.add('active');
      if (tab === 'charts') renderCharts();
      if (tab === 'badges') renderBadges();
      if (tab === 'lifetime') renderLifetimeStats();
    }

    function getPlayerStats(yearData) {
      var data = yearData || { players: appData.players, nights: appData.nights };
      return data.players.map(function(player) {
        var games = data.nights.filter(function(n) {
          return n.attendees.some(function(a) { return a.playerId === player.id; });
        }).length;
        var totalWinnings = data.nights.reduce(function(sum, night) {
          var attendee = night.attendees.find(function(a) { return a.playerId === player.id; });
          return sum + (attendee ? attendee.winnings : 0);
        }, 0);
        var avgWinnings = games > 0 ? totalWinnings / games : 0;
        return { id: player.id, name: player.name, games: games, totalWinnings: totalWinnings, avgWinnings: avgWinnings };
      });
    }

    function getAchievements(stats, yearData) {
      var achievements = [];
      var data = yearData || { players: appData.players, nights: appData.nights };
      var allStats = getPlayerStats(yearData);
      var maxWinnings = Math.max.apply(Math, allStats.map(function(s) { return s.totalWinnings; }));
      if (stats.totalWinnings === maxWinnings && maxWinnings > 0) achievements.push('üèÜ Top Earner YTD');
      var playerNights = data.nights.filter(function(n) {
        return n.attendees.some(function(a) { return a.playerId === stats.id; });
      }).sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
      var streak = 0, maxStreak = 0;
      playerNights.forEach(function(night) {
        var attendee = night.attendees.find(function(a) { return a.playerId === stats.id; });
        if (attendee.winnings > 0) { streak++; maxStreak = Math.max(maxStreak, streak); } else streak = 0;
      });
      if (maxStreak >= 3) achievements.push('üî• Hot Streak');
      var maxWin = Math.max.apply(Math, playerNights.map(function(n) {
        var a = n.attendees.find(function(at) { return at.playerId === stats.id; });
        return a ? a.winnings : -Infinity;
      }).concat([0]));
      if (maxWin >= 100) achievements.push('üíé High Roller');
      if (stats.games >= 5) achievements.push('üéÆ Regular Player');
      if (stats.games >= 20) achievements.push('üåü Veteran');
      if (stats.games >= 50) achievements.push('üíØ Half Century');
      if (stats.totalWinnings >= 100) achievements.push('üíµ $100 Club');
      if (stats.totalWinnings >= 500) achievements.push('üíé $500 Club');
      return achievements;
    }

    function showPlayerProfile(playerId) {
      var player = appData.players.find(function(p) { return p.id === playerId; });
      var stats = getPlayerStats().find(function(s) { return s.id === playerId; });
      var achievements = getAchievements(stats);
      document.getElementById('playerProfileName').textContent = player.name;
      var content = document.getElementById('playerProfileContent');
      content.innerHTML = '<div class="stats-grid">' +
        '<div class="stat-card"><div class="stat-value">' + stats.games + '</div><div class="stat-label">Games Played</div></div>' +
        '<div class="stat-card"><div class="stat-value">$' + stats.totalWinnings.toFixed(2) + '</div><div class="stat-label">Total Winnings</div></div>' +
        '<div class="stat-card"><div class="stat-value">$' + stats.avgWinnings.toFixed(2) + '</div><div class="stat-label">Avg per Game</div></div>' +
        '</div><h3>Achievements</h3><div>' +
        achievements.map(function(a) { return '<span class="achievement">' + a + '</span>'; }).join('') +
        (achievements.length === 0 ? '<p>No achievements yet</p>' : '') +
        '</div><h3>Performance Over Time</h3>';
      var history = appData.nights.filter(function(n) {
        return n.attendees.some(function(a) { return a.playerId === playerId; });
      }).sort(function(a, b) { return new Date(a.date) - new Date(b.date); }).map(function(night) {
        return { date: night.date, winnings: night.attendees.find(function(a) { return a.playerId === playerId; }).winnings };
      });
      var ctx = document.getElementById('playerHistoryChart');
      if (charts.playerHistory) charts.playerHistory.destroy();
      charts.playerHistory = new Chart(ctx, {
        type: 'line',
        data: {
          labels: history.map(function(h) { return h.date; }),
          datasets: [{ label: 'Winnings', data: history.map(function(h) { return h.winnings; }), borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', tension: 0.4 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
            x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
          }
        }
      });
      document.getElementById('playerProfileModal').classList.add('active');
    }

    function renderLeaderboard() {
      var year = document.getElementById('leaderboardYearSelect').value;
      var yearData = getYearData(year);
      var stats = getPlayerStats(yearData).sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
      var list = document.getElementById('leaderboardList');
      list.innerHTML = stats.map(function(s, i) {
        var achievements = getAchievements(s, yearData);
        return '<div class="leaderboard-item" onclick="showPlayerProfile(' + s.id + ')">' +
          '<div><strong>' + (i + 1) + '. ' + s.name + '</strong><div>' +
          achievements.map(function(a) { return '<span class="achievement">' + a + '</span>'; }).join('') +
          '</div></div><div style="text-align: right;">' +
          '<div style="font-size: 1.5em; color: ' + (s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + s.totalWinnings.toFixed(2) + '</div>' +
          '<div style="font-size: 0.9em; color: #aaa;">' + s.games + ' games ‚Ä¢ $' + s.avgWinnings.toFixed(2) + ' avg</div>' +
          '</div></div>';
      }).join('');
    }

    function renderCharts() {
      var year = document.getElementById('chartsYearSelect').value;
      var yearData = getYearData(year);
      var stats = getPlayerStats(yearData).sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
      var ctx1 = document.getElementById('totalWinningsChart');
      if (charts.totalWinnings) charts.totalWinnings.destroy();
      charts.totalWinnings = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: stats.map(function(s) { return s.name; }),
          datasets: [{ label: 'Total Winnings', data: stats.map(function(s) { return s.totalWinnings; }), backgroundColor: stats.map(function(s) { return s.totalWinnings >= 0 ? 'rgba(46, 204, 113, 0.8)' : 'rgba(231, 76, 60, 0.8)'; }) }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
      });
      var ctx2 = document.getElementById('gamesPlayedChart');
      if (charts.gamesPlayed) charts.gamesPlayed.destroy();
      charts.gamesPlayed = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: stats.map(function(s) { return s.name; }),
          datasets: [{ label: 'Games Played', data: stats.map(function(s) { return s.games; }), backgroundColor: 'rgba(243, 156, 18, 0.8)' }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
      });
      var ctx3 = document.getElementById('avgWinningsChart');
      if (charts.avgWinnings) charts.avgWinnings.destroy();
      charts.avgWinnings = new Chart(ctx3, {
        type: 'line',
        data: {
          labels: stats.map(function(s) { return s.name; }),
          datasets: [{ label: 'Average Winnings', data: stats.map(function(s) { return s.avgWinnings; }), borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', tension: 0.4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e4e4e4' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
      });
    }

    function renderBadges() {
      var badgeDefs = [
        { badge: 'üèÜ Top Earner YTD', description: 'Highest total winnings this year' },
        { badge: 'üî• Hot Streak', description: '3+ wins in a row' },
        { badge: 'üíé High Roller', description: 'Single win of $100+' },
        { badge: 'üéÆ Regular Player', description: '5+ games played' },
        { badge: 'üåü Veteran', description: '20+ games played' },
        { badge: 'üíØ Half Century', description: '50+ games played' },
        { badge: 'üíµ $100 Club', description: '$100+ total winnings' },
        { badge: 'üíé $500 Club', description: '$500+ total winnings' }
      ];
      var stats = getPlayerStats();
      var badgeHolders = {};
      stats.forEach(function(s) {
        var achievements = getAchievements(s);
        achievements.forEach(function(badge) {
          if (!badgeHolders[badge]) badgeHolders[badge] = [];
          badgeHolders[badge].push(s.name);
        });
      });
      var list = document.getElementById('badgesList');
      list.innerHTML = badgeDefs.map(function(def) {
        var holders = badgeHolders[def.badge] || [];
        return '<div class="badge-card">' +
          '<div class="badge-header">' + def.badge + '</div>' +
          '<div style="color: #aaa; margin-bottom: 10px;">' + def.description + '</div>' +
          '<div class="badge-players">' +
          (holders.length > 0 ? holders.map(function(name) { return '<span class="badge-player-tag">' + name + '</span>'; }).join('') : '<span style="color: #888;">No players have earned this badge yet</span>') +
          '</div></div>';
      }).join('');
    }

    function renderLifetimeStats() {
      var lifetimeStats = {};
      appData.players.forEach(function(player) {
        lifetimeStats[player.id] = { name: player.name, totalGames: 0, totalWinnings: 0, years: {} };
      });
      Object.keys(appData.archivedYears || {}).forEach(function(year) {
        var yearData = appData.archivedYears[year];
        var yearStats = getPlayerStats(yearData);
        yearStats.forEach(function(s) {
          if (lifetimeStats[s.id]) {
            lifetimeStats[s.id].totalGames += s.games;
            lifetimeStats[s.id].totalWinnings += s.totalWinnings;
            lifetimeStats[s.id].years[year] = { games: s.games, winnings: s.totalWinnings };
          }
        });
      });
      var currentStats = getPlayerStats();
      currentStats.forEach(function(s) {
        if (lifetimeStats[s.id]) {
          lifetimeStats[s.id].totalGames += s.games;
          lifetimeStats[s.id].totalWinnings += s.totalWinnings;
          lifetimeStats[s.id].years[appData.currentYear] = { games: s.games, winnings: s.totalWinnings };
        }
      });
      var sortedLifetime = Object.values(lifetimeStats).filter(function(s) { return s.totalGames > 0; }).sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
      var lifetimeList = document.getElementById('lifetimeLeaderboard');
      lifetimeList.innerHTML = sortedLifetime.map(function(s, i) {
        return '<div class="leaderboard-item">' +
          '<div><strong>' + (i + 1) + '. ' + s.name + '</strong></div>' +
          '<div style="text-align: right;">' +
          '<div style="font-size: 1.5em; color: ' + (s.totalWinnings >= 0 ? '#2ecc71' : '#e74c3c') + '">$' + s.totalWinnings.toFixed(2) + '</div>' +
          '<div style="font-size: 0.9em; color: #aaa;">' + s.totalGames + ' lifetime games ‚Ä¢ $' + (s.totalWinnings / s.totalGames).toFixed(2) + ' avg</div>' +
          '</div></div>';
      }).join('');
      var yearByYear = document.getElementById('yearByYearStats');
      var years = Object.keys(appData.archivedYears || {}).concat([appData.currentYear.toString()]).sort(function(a, b) { return b - a; });
      yearByYear.innerHTML = years.map(function(year) {
        var yearData = year == appData.currentYear ? { players: appData.players, nights: appData.nights } : appData.archivedYears[year];
        if (!yearData || !yearData.nights || yearData.nights.length === 0) return '';
        var yearStats = getPlayerStats(yearData).sort(function(a, b) { return b.totalWinnings - a.totalWinnings; });
        var topPlayer = yearStats[0];
        return '<div class="card">' +
          '<h3>' + year + (year == appData.currentYear ? ' (Current)' : '') + '</h3>' +
          '<p>Games: ' + yearData.nights.length + '</p>' +
          '<p>Top Player: ' + (topPlayer ? topPlayer.name + ' ($' + topPlayer.totalWinnings.toFixed(2) + ')' : 'N/A') + '</p>' +
          '</div>';
      }).join('');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function refreshData() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('appContent').style.display = 'none';
      document.getElementById('errorState').style.display = 'none';
      loadData();
    }

    loadData();
  </script>
</body>
</html>